<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Karl Tayeb" />

<meta name="date" content="2022-10-20" />

<title>logistic_susie_initialization</title>

<script src="site_libs/header-attrs-2.14/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/main/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">logistic-susie-gsea</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/karltayeb/logistic-susie-gsea">
    <span class="fab fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">logistic_susie_initialization</h1>
<h4 class="author">Karl Tayeb</h4>
<h4 class="date">2022-10-20</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span>
workflowr <span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span
class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2022-11-08
</p>
<p>
<strong>Checks:</strong> <span
class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 7
<span class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span> 0
</p>
<p>
<strong>Knit directory:</strong> <code>logistic-susie-gsea/</code> <span
class="glyphicon glyphicon-question-sign" aria-hidden="true"
title="This is the local directory in which the code in this file was executed.">
</span>
</p>
<p>
This reproducible <a href="https://rmarkdown.rstudio.com">R Markdown</a>
analysis was created with <a
  href="https://github.com/workflowr/workflowr">workflowr</a> (version
1.7.0). The <em>Checks</em> tab describes the reproducibility checks
that were applied when the results were created. The <em>Past
versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date
</a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate"
class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git
repository, you know the exact version of the code that produced these
results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the
global environment can affect the analysis in your R Markdown file in
unknown ways. For reproduciblity it’s best to always run the code in an
empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20220105code">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Seed:</strong>
<code>set.seed(20220105)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20220105code"
class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20220105)</code> was run prior to running
the code in the R Markdown file. Setting a seed ensures that any results
that rely on randomness, e.g. subsampling or permutations, are
reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Session information:</strong>
recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded"
class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package
versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be
confident that you successfully produced the results during this
run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr
project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomkarltayeblogisticsusiegseatreee16019e7ce9b99779766244fe831cb7aca368bc0targetblanke16019ea">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Repository version:</strong>
<a href="https://github.com/karltayeb/logistic-susie-gsea/tree/e16019e7ce9b99779766244fe831cb7aca368bc0" target="_blank">e16019e</a>
</a>
</p>
</div>
<div
id="strongRepositoryversionstrongahrefhttpsgithubcomkarltayeblogisticsusiegseatreee16019e7ce9b99779766244fe831cb7aca368bc0targetblanke16019ea"
class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development
and connecting the code version to the results is critical for
reproducibility.
</p>
<p>
The results in this page were generated with repository version
<a href="https://github.com/karltayeb/logistic-susie-gsea/tree/e16019e7ce9b99779766244fe831cb7aca368bc0" target="_blank">e16019e</a>.
See the <em>Past versions</em> tab to see a history of the changes made
to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for
the analysis have been committed to Git prior to generating the results
(you can use <code>wflow_publish</code> or
<code>wflow_git_commit</code>). workflowr only checks the R Markdown
file, but you know if there are other scripts or data files that it
depends on. Below is the status of the Git repository when the results
were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .DS_Store
    Ignored:    .RData
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    _targets.R
    Ignored:    _targets.html
    Ignored:    _targets.md
    Ignored:    _targets/objects/
    Ignored:    _targets/user/
    Ignored:    _targets/workspaces/
    Ignored:    cache/
    Ignored:    data/.DS_Store
    Ignored:    data/adipose_2yr_topsnp.txt
    Ignored:    data/anthony/
    Ignored:    data/bohan_example/
    Ignored:    data/de-droplet/
    Ignored:    data/de-microplastics/
    Ignored:    data/deng/
    Ignored:    data/fetal_reference_cellid_gene_sets.RData
    Ignored:    data/human_chimp_eb/
    Ignored:    data/pbmc-purified/
    Ignored:    data/wenhe_baboon_diet/
    Ignored:    data/yusha_sc_tumor/
    Ignored:    library/

Untracked files:
    Untracked:  .ipynb_checkpoints/
    Untracked:  Master's Paper.pdf
    Untracked:  VEB_Boost_Proposal_Write_Up (1).pdf
    Untracked:  _targets/meta/
    Untracked:  additive.l5.gonr.aggregate.scores
    Untracked:  analysis/2022_09_22_pdac_example.Rmd
    Untracked:  analysis/alpha_ash_v_point_normal.Rmd
    Untracked:  analysis/bohan_troubleshoot.Rmd
    Untracked:  analysis/compare_w_post_hoc_clustering.Rmd
    Untracked:  analysis/compute_exact_BFs.Rmd
    Untracked:  analysis/constrained_q_alpha_update.Rmd
    Untracked:  analysis/de_droplet_noshrink.Rmd
    Untracked:  analysis/de_droplet_noshrink_logistic_susie.Rmd
    Untracked:  analysis/detection_problem.Rmd
    Untracked:  analysis/exact_logistic_ser.Rmd
    Untracked:  analysis/expected_condition_bfs.Rmd
    Untracked:  analysis/fetal_reference_cellid_gsea.Rmd
    Untracked:  analysis/fixed_intercept.Rmd
    Untracked:  analysis/gsea_made_simple.Rmd
    Untracked:  analysis/iDEA_examples.Rmd
    Untracked:  analysis/latent_gene_list.Rmd
    Untracked:  analysis/linear_method_failure_modes.Rmd
    Untracked:  analysis/linear_regression_failure_regime.Rmd
    Untracked:  analysis/linear_v_logistic_pbmc.Rmd
    Untracked:  analysis/logistic_susie_rss.Rmd
    Untracked:  analysis/logistic_susie_veb_boost_vs_vb.Rmd
    Untracked:  analysis/logistic_susie_vis.Rmd
    Untracked:  analysis/logistic_variational_bound.Rmd
    Untracked:  analysis/logsitic_susie_template.Rmd
    Untracked:  analysis/normal_means.Rmd
    Untracked:  analysis/pcb_scratch.Rmd
    Untracked:  analysis/references.bib
    Untracked:  analysis/roadmap.Rmd
    Untracked:  analysis/sc_tumor_followup.Rmd
    Untracked:  analysis/ser_detection_threshold.Rmd
    Untracked:  analysis/simulations.Rmd
    Untracked:  analysis/simulations_l1.Rmd
    Untracked:  analysis/tccm_vs_logistic_susie.Rmd
    Untracked:  analysis/template.Rmd
    Untracked:  analysis/test.Rmd
    Untracked:  analysis/univariate_laplace_approximation.Rmd
    Untracked:  analysis/vb_ser_susie.Rmd
    Untracked:  analysis/vb_susie.Rmd
    Untracked:  analysis/z_score_vs_threshold.Rmd
    Untracked:  build_site.R
    Untracked:  code/binromial_ser.R
    Untracked:  code/html_tables.R
    Untracked:  code/latent_logistic_susie.R
    Untracked:  code/logistic_susie_data_driver.R
    Untracked:  code/marginal_sumstat_gsea_collapsed.R
    Untracked:  code/point_normal.R
    Untracked:  code/sumstat_gsea.py
    Untracked:  code/susie_gsea_queries.R
    Untracked:  docs.zip
    Untracked:  export/
    Untracked:  figure/
    Untracked:  l1.sim.aggregate.scores
    Untracked:  pbmc_cd19_symbol.txt
    Untracked:  pbmc_cd19b_0.1_background.csv
    Untracked:  pbmc_cd19b_0.1_david_annotation_clusters.txt
    Untracked:  pbmc_cd19b_0.1_david_results.txt
    Untracked:  pbmc_cd19b_0.1_list.csv
    Untracked:  presentations/
    Untracked:  references.bib

Unstaged changes:
    Modified:   _targets.Rmd
    Modified:   analysis/approximate_bayes_factors.Rmd
    Modified:   analysis/example_pbmc.Rmd
    Modified:   analysis/logistic_ser_undercovers.Rmd

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not
included in this status report because it is ok for generated content to
have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were
made to the R Markdown
(<code>analysis/logistic_susie_initialization.Rmd</code>) and HTML
(<code>docs/logistic_susie_initialization.html</code>) files. If you’ve
configured a remote Git repository (see <code>?wflow_git_remote</code>),
click on the hyperlinks in the table below to view the files as they
were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/e16019e7ce9b99779766244fe831cb7aca368bc0/analysis/logistic_susie_initialization.Rmd" target="_blank">e16019e</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
<td>
wflow_publish("analysis/logistic_susie_initialization.Rmd")
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/karltayeb/logistic-susie-gsea/e716f37a0cc26f76a42129d59e0d42ca52ab215f/docs/logistic_susie_initialization.html" target="_blank">e716f37</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/15d235b9c79978ffe5c7e2fd2d40b6635285e916/analysis/logistic_susie_initialization.Rmd" target="_blank">15d235b</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
<td>
wflow_publish("analysis/logistic_susie_initialization.Rmd")
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/karltayeb/logistic-susie-gsea/606428425c32ae1ffbf860e5850427c13895288a/docs/logistic_susie_initialization.html" target="_blank">6064284</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/d3581d4d7e070f0f0c41b4df65c7a6256013c080/analysis/logistic_susie_initialization.Rmd" target="_blank">d3581d4</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
<td>
wflow_publish("analysis/logistic_susie_initialization.Rmd")
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/karltayeb/logistic-susie-gsea/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/logistic_susie_initialization.html" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/83a51c9ff7ea7099359455b1c57db22f3a006940/analysis/logistic_susie_initialization.Rmd" target="_blank">83a51c9</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
<td>
wflow_publish("analysis/logistic_susie_initialization.Rmd")
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/karltayeb/logistic-susie-gsea/b3f98c6debb36fc31f28d5cf2b0fcbb96748b830/docs/logistic_susie_initialization.html" target="_blank">b3f98c6</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/ec873de76f506a1708b2335d5218358cd58be9e0/analysis/logistic_susie_initialization.Rmd" target="_blank">ec873de</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
<td>
wflow_publish("analysis/logistic_susie_initialization.Rmd")
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/karltayeb/logistic-susie-gsea/83e284bb84d9e6b882805e4114c5febc094fc662/docs/logistic_susie_initialization.html" target="_blank">83e284b</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/228b0b725db62aaa0f35259e59d2ac860bb2f299/analysis/logistic_susie_initialization.Rmd" target="_blank">228b0b7</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
<td>
wflow_publish("analysis/logistic_susie_initialization.Rmd")
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/karltayeb/logistic-susie-gsea/6728f824474066744b11556e451965d441e3a977/docs/logistic_susie_initialization.html" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/a6493a8427caa489f8c9c406044c1eefe19979b5/analysis/logistic_susie_initialization.Rmd" target="_blank">a6493a8</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
<td>
wflow_publish("analysis/logistic_susie_initialization.Rmd")
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The purpose of this notebook is to explore the effect of
initialization on the results we get with the logistic SER and logistic
SuSiE.</p>
<p>First, We have real data examples from Yusha where the default
initialization does not result in a good final model fit. We will
explore step-wise regression based initialization and other options to
try and rescue this example.</p>
<p>Second, most of our simulations do not seem to struggle with the
default initialization, while the real data examples do. We should try
to reproduce the regimes that the default initialization fails.</p>
<p>Finally, even when we optimize to a good local optimum, we have
demonstrated the the credible sets from the logistic SER do not achieve
empirical coverage. In particular we have highlighted the role of the
Polya-Gamma variational parameters in complicating the fair comparison
of competing single effect models. The consequences are easy enough to
understand in the SER case, and we should also be cautious of it’s
impact on the behvior of logistic SuSiE.</p>
<pre class="r"><code>cache_rds &lt;- purrr::partial(xfun::cache_rds, dir=&#39;cache/initialization/&#39;)</code></pre>
</div>
<div id="yushas-examples" class="section level2">
<h2>Yusha’s Examples</h2>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
<pre><code>✔ ggplot2 3.3.6      ✔ purrr   0.3.4 
✔ tibble  3.1.8      ✔ dplyr   1.0.10
✔ tidyr   1.2.1      ✔ stringr 1.4.0 
✔ readr   2.1.2      ✔ forcats 0.5.2 </code></pre>
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>library(tictoc)
library(kableExtra)</code></pre>
<pre><code>
Attaching package: &#39;kableExtra&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:dplyr&#39;:

    group_rows</code></pre>
<pre class="r"><code>devtools::load_all(&#39;~/R/logisticsusie/&#39;)</code></pre>
<pre><code>ℹ Loading logisticsusie</code></pre>
<pre class="r"><code>example &lt;- readRDS(&#39;data/yusha_sc_tumor/pdac_example.rds&#39;)
bindata &lt;- with(example, gseasusie::prep_binary_data(genesets, data, thresh = 0.01))
gs_names &lt;- colnames(bindata$X)
n_gene_sets &lt;- dim(bindata$X)[2]

example2 &lt;- readRDS(&#39;data/yusha_sc_tumor/pdac_example2.rds&#39;)
bindata2 &lt;- with(example, gseasusie::prep_binary_data(genesets, data, thresh = 0.01))
gs_names2 &lt;- colnames(bindata$X)
n_gene_sets2 &lt;- dim(bindata$X)[2]</code></pre>
<pre class="r"><code>get_elbo &lt;- function(fit){tail(fit$elbo, 1)}

set_xi &lt;- function(fit, xi){
  fit$params$xi &lt;- xi
  fit$params$tau &lt;- compute_tau(fit)
  return(fit)
}

get_bf &lt;- function(fit){
  compute_elbo2.binsusie(fit) - null_elbo
}

# compute lbf for each feature
get_lbf_variable &lt;- function(fit){
  p &lt;- dim(fit$data$X)[2]
  null_fit &lt;- fit_univariate_vb(fit$data$X[, 1], fit$data$y, tau0=1e10)
  lbf_variable &lt;- map_dbl(1:p, ~compute_elbo(
    x=fit$data$X[, .x],
    y=fit$data$y,
    o=0,
    mu=fit$params$mu[.x],
    tau=1/fit$params$var[.x],
    xi=fit$params$xi,
    delta=fit$params$delta[1,1],
    tau0=1/fit$hypers$prior_variance
  )) - tail(null_fit$elbos, 1)
  return(lbf_variable)
}

# compute lbf for the SER
get_lbf_ser &lt;- function(fit){
  null_fit &lt;- fit_univariate_vb(fit$data$X[, 1], fit$data$y, tau0=1e10)
  lbf &lt;- get_elbo(fit) - tail(null_fit$elbos, 1)
  return(lbf)
}


# convenient table of CSs
cs_tbl &lt;- function(fit){
  fit %&gt;% get_all_cs() %&gt;% tibble() %&gt;% 
    unnest_wider(1) %&gt;%
    rowwise() %&gt;%
    mutate(top_feaure = cs[1], top_feature_alpha = prob[1])#%&gt;% unnest_longer(c(cs, prob))
}</code></pre>
<div id="there-are-marginal-enrichments" class="section level3">
<h3>There are marginal enrichments</h3>
<p>We know the default initialization does not work well because
although there are several independent marginal association signals
logistic SuSiE does not identify any of them. There are several
independent enrichment signals, here we show the correlation among all
enrichments at a FDR of 5% (BH, Fisher’s exact test).</p>
<pre class="r"><code>ora &lt;- with(bindata, gseasusie::fit_ora(X, y))</code></pre>
<pre><code>computing ORA statistics...</code></pre>
<pre><code>0.602 sec elapsed</code></pre>
<pre class="r"><code>marginal_idx &lt;- which(p.adjust(ora$pFishersExact, method=&#39;bonferroni&#39;) &lt; 0.05)
heatmap(cor(as.matrix(bindata$X[, marginal_idx])), scale=&#39;none&#39;, main=&#39;Marginally enriched gene sets, p.bonferroni &lt; 0.05&#39;)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/marginal-results-bf-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-marginal-results-bf-1">
Past versions of marginal-results-bf-1.png
</button>
</p>
<div id="fig-marginal-results-bf-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/marginal-results-bf-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>marginal_idx &lt;- which(p.adjust(ora$pFishersExact, method=&#39;BH&#39;) &lt; 0.05)
heatmap(cor(as.matrix(bindata$X[, marginal_idx])),
        scale=&#39;none&#39;, main=&#39;Marginally enriched gene sets, p.BH &lt; 0.05&#39;)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/marginal-results-bh-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-marginal-results-bh-1">
Past versions of marginal-results-bh-1.png
</button>
</p>
<div id="fig-marginal-results-bh-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/marginal-results-bh-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>ora %&gt;% arrange(pFishersExact) %&gt;%
  mutate(nl10p_fishers = -log10(pFishersExact)) %&gt;%
  select(geneSet, geneSetSize, overlap, oddsRatio, nl10p_fishers) %&gt;%
  head(50) %&gt;%
  kbl(caption = &#39;Marginal enrichments ranked by -log10(p)&#39;) %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
Marginal enrichments ranked by -log10(p)
</caption>
<thead>
<tr>
<th style="text-align:left;">
geneSet
</th>
<th style="text-align:right;">
geneSetSize
</th>
<th style="text-align:right;">
overlap
</th>
<th style="text-align:right;">
oddsRatio
</th>
<th style="text-align:right;">
nl10p_fishers
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
M522
</td>
<td style="text-align:right;">
75
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
6.4051846
</td>
<td style="text-align:right;">
5.652686
</td>
</tr>
<tr>
<td style="text-align:left;">
M5336
</td>
<td style="text-align:right;">
397
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
5.254835
</td>
</tr>
<tr>
<td style="text-align:left;">
M543
</td>
<td style="text-align:right;">
488
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.0599932
</td>
<td style="text-align:right;">
5.242160
</td>
</tr>
<tr>
<td style="text-align:left;">
M546
</td>
<td style="text-align:right;">
35
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
9.7949047
</td>
<td style="text-align:right;">
5.123475
</td>
</tr>
<tr>
<td style="text-align:left;">
M706
</td>
<td style="text-align:right;">
62
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
6.4035088
</td>
<td style="text-align:right;">
4.826582
</td>
</tr>
<tr>
<td style="text-align:left;">
M19248
</td>
<td style="text-align:right;">
53
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
6.7809197
</td>
<td style="text-align:right;">
4.579956
</td>
</tr>
<tr>
<td style="text-align:left;">
M5907
</td>
<td style="text-align:right;">
145
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
3.9036145
</td>
<td style="text-align:right;">
4.509714
</td>
</tr>
<tr>
<td style="text-align:left;">
M27416
</td>
<td style="text-align:right;">
47
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
6.7668593
</td>
<td style="text-align:right;">
4.133883
</td>
</tr>
<tr>
<td style="text-align:left;">
M27303
</td>
<td style="text-align:right;">
29
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
8.5311801
</td>
<td style="text-align:right;">
3.704613
</td>
</tr>
<tr>
<td style="text-align:left;">
M27372
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
18.5278450
</td>
<td style="text-align:right;">
3.629524
</td>
</tr>
<tr>
<td style="text-align:left;">
M27662
</td>
<td style="text-align:right;">
287
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
3.578823
</td>
</tr>
<tr>
<td style="text-align:left;">
M27410
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
16.2090395
</td>
<td style="text-align:right;">
3.463875
</td>
</tr>
<tr>
<td style="text-align:left;">
M27620
</td>
<td style="text-align:right;">
325
</td>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
2.4855429
</td>
<td style="text-align:right;">
3.444443
</td>
</tr>
<tr>
<td style="text-align:left;">
M16843
</td>
<td style="text-align:right;">
470
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.1905180
</td>
<td style="text-align:right;">
3.412726
</td>
</tr>
<tr>
<td style="text-align:left;">
M27958
</td>
<td style="text-align:right;">
33
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
7.2622222
</td>
<td style="text-align:right;">
3.381053
</td>
</tr>
<tr>
<td style="text-align:left;">
M27412
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
14.4055242
</td>
<td style="text-align:right;">
3.314606
</td>
</tr>
<tr>
<td style="text-align:left;">
M653
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
12.9627119
</td>
<td style="text-align:right;">
3.178900
</td>
</tr>
<tr>
<td style="text-align:left;">
M27483
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
11.7822291
</td>
<td style="text-align:right;">
3.054613
</td>
</tr>
<tr>
<td style="text-align:left;">
M556
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
11.7822291
</td>
<td style="text-align:right;">
3.054613
</td>
</tr>
<tr>
<td style="text-align:left;">
M29844
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
24.1938202
</td>
<td style="text-align:right;">
3.047924
</td>
</tr>
<tr>
<td style="text-align:left;">
M5946
</td>
<td style="text-align:right;">
84
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
3.9565116
</td>
<td style="text-align:right;">
3.013947
</td>
</tr>
<tr>
<td style="text-align:left;">
M41835
</td>
<td style="text-align:right;">
72
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
4.1054913
</td>
<td style="text-align:right;">
2.835828
</td>
</tr>
<tr>
<td style="text-align:left;">
M820
</td>
<td style="text-align:right;">
29
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
6.7732008
</td>
<td style="text-align:right;">
2.784119
</td>
</tr>
<tr>
<td style="text-align:left;">
M13087
</td>
<td style="text-align:right;">
213
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
2.714742
</td>
</tr>
<tr>
<td style="text-align:left;">
M495
</td>
<td style="text-align:right;">
31
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
6.2500000
</td>
<td style="text-align:right;">
2.649990
</td>
</tr>
<tr>
<td style="text-align:left;">
M649
</td>
<td style="text-align:right;">
116
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
3.1115525
</td>
<td style="text-align:right;">
2.565117
</td>
</tr>
<tr>
<td style="text-align:left;">
M684
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
8.0932203
</td>
<td style="text-align:right;">
2.556361
</td>
</tr>
<tr>
<td style="text-align:left;">
M3634
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
13.8178170
</td>
<td style="text-align:right;">
2.542294
</td>
</tr>
<tr>
<td style="text-align:left;">
M15434
</td>
<td style="text-align:right;">
201
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
2.536525
</td>
</tr>
<tr>
<td style="text-align:left;">
M27334
</td>
<td style="text-align:right;">
33
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
5.8015422
</td>
<td style="text-align:right;">
2.526259
</td>
</tr>
<tr>
<td style="text-align:left;">
M1070
</td>
<td style="text-align:right;">
208
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
2.519135
</td>
</tr>
<tr>
<td style="text-align:left;">
M1036
</td>
<td style="text-align:right;">
630
</td>
<td style="text-align:right;">
32
</td>
<td style="text-align:right;">
1.8488474
</td>
<td style="text-align:right;">
2.502054
</td>
</tr>
<tr>
<td style="text-align:left;">
M734
</td>
<td style="text-align:right;">
768
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
0.4264434
</td>
<td style="text-align:right;">
2.480535
</td>
</tr>
<tr>
<td style="text-align:left;">
M525
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
12.0884831
</td>
<td style="text-align:right;">
2.413791
</td>
</tr>
<tr>
<td style="text-align:left;">
M18647
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
12.0884831
</td>
<td style="text-align:right;">
2.413791
</td>
</tr>
<tr>
<td style="text-align:left;">
M41824
</td>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
7.1914626
</td>
<td style="text-align:right;">
2.398132
</td>
</tr>
<tr>
<td style="text-align:left;">
M27185
</td>
<td style="text-align:right;">
189
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
2.358309
</td>
</tr>
<tr>
<td style="text-align:left;">
M11575
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10.7434457
</td>
<td style="text-align:right;">
2.298636
</td>
</tr>
<tr>
<td style="text-align:left;">
M2341
</td>
<td style="text-align:right;">
38
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
4.9182163
</td>
<td style="text-align:right;">
2.254359
</td>
</tr>
<tr>
<td style="text-align:left;">
M11980
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
9.6674157
</td>
<td style="text-align:right;">
2.194462
</td>
</tr>
<tr>
<td style="text-align:left;">
M971
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
5.8798151
</td>
<td style="text-align:right;">
2.128963
</td>
</tr>
<tr>
<td style="text-align:left;">
M913
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
8.7870276
</td>
<td style="text-align:right;">
2.099481
</td>
</tr>
<tr>
<td style="text-align:left;">
M27275
</td>
<td style="text-align:right;">
76
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
3.3099284
</td>
<td style="text-align:right;">
2.087942
</td>
</tr>
<tr>
<td style="text-align:left;">
M27103
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
4.3834459
</td>
<td style="text-align:right;">
2.067821
</td>
</tr>
<tr>
<td style="text-align:left;">
M5485
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
3.6139683
</td>
<td style="text-align:right;">
2.021190
</td>
</tr>
<tr>
<td style="text-align:left;">
M5901
</td>
<td style="text-align:right;">
163
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
2.003710
</td>
</tr>
<tr>
<td style="text-align:left;">
M27050
</td>
<td style="text-align:right;">
164
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
2.003024
</td>
</tr>
<tr>
<td style="text-align:left;">
M5925
</td>
<td style="text-align:right;">
172
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
1.976110
</td>
</tr>
<tr>
<td style="text-align:left;">
M14033
</td>
<td style="text-align:right;">
172
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
1.976110
</td>
</tr>
<tr>
<td style="text-align:left;">
M5930
</td>
<td style="text-align:right;">
141
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
2.5065845
</td>
<td style="text-align:right;">
1.970215
</td>
</tr>
</tbody>
</table>
</div>
<div id="default-initialization-converges-to-the-null-model-or-worse"
class="section level3">
<h3>Default initialization converges to the null model (or worse)</h3>
<p>Unfortunately, our default initialization yields NO significant
enrichment for either logistic SuSiE or the logistic SER. If we fix the
prior variance, we learn a model that has a worse ELBO than the null
model. If we estimate the prior variance parametes, they are shrunk
close to zero (i.e. we estimate the null model).</p>
<pre class="r"><code>tic(&#39;L=10, fixed prior variance&#39;)
fit.default &lt;- cache_rds(with(bindata, binsusie(X, y, prior_variance=10, estimate_prior_variance=F)), file=&#39;fit.default&#39;)
toc()</code></pre>
<pre><code>L=10, fixed prior variance: 0.638 sec elapsed</code></pre>
<pre class="r"><code>get_elbo(fit.default)</code></pre>
<pre><code>[1] -821.4436</code></pre>
<pre class="r"><code>tic(&#39;L=10, estimate prior variance&#39;)
fit.default2 &lt;- cache_rds(with(bindata, binsusie(X, y, prior_variance=10, estimate_prior_variance=T)), file=&#39;fit.default2&#39;)
toc()</code></pre>
<pre><code>L=10, estimate prior variance: 0.614 sec elapsed</code></pre>
<pre class="r"><code>get_elbo(fit.default2)</code></pre>
<pre><code>[1] -809.7458</code></pre>
<pre class="r"><code>tic(&#39;L=10, null model&#39;)
fit.null &lt;- cache_rds(with(bindata, binsusie(X, y, prior_variance=1e-10, estimate_prior_variance=F)), file=&#39;fit.null&#39;)
toc()</code></pre>
<pre><code>L=10, null model: 0.402 sec elapsed</code></pre>
<pre class="r"><code>get_elbo(fit.null)</code></pre>
<pre><code>[1] -809.6773</code></pre>
<pre class="r"><code>tic(&#39;SER, fixed prior variance&#39;)
ser.default &lt;- cache_rds(with(bindata, binsusie(X, y, L = 1, prior_variance = 10, estimate_prior_variance = F)), file=&#39;ser.default&#39;)
toc()</code></pre>
<pre><code>SER, fixed prior variance: 0.391 sec elapsed</code></pre>
<pre class="r"><code>get_elbo(ser.default)</code></pre>
<pre><code>[1] -810.7019</code></pre>
<pre class="r"><code>tic(&#39;SER, estimate prior variance&#39;)
ser.default2 &lt;- cache_rds(with(bindata, binsusie(X, y, L = 1, prior_variance = 10, estimate_prior_variance = T)), file=&#39;ser.default2&#39;)
toc()</code></pre>
<pre><code>SER, estimate prior variance: 0.283 sec elapsed</code></pre>
<pre class="r"><code>get_elbo(ser.default2)</code></pre>
<pre><code>[1] -809.697</code></pre>
<pre class="r"><code>tic(&#39;SER, null model&#39;)
ser.null &lt;- cache_rds(with(bindata, binsusie(X, y, L = 1, prior_variance = 1e-10, estimate_prior_variance = T)), file=&#39;ser.null&#39;)
toc()</code></pre>
<pre><code>SER, null model: 0.393 sec elapsed</code></pre>
<pre class="r"><code>get_elbo(ser.null)</code></pre>
<pre><code>[1] -809.6773</code></pre>
<pre class="r"><code>cs_tbl(fit.default)</code></pre>
<pre><code># A tibble: 10 × 7
# Rowwise: 
   cs            prob           size requested_coverage coverage top_f…¹ top_f…²
   &lt;list&gt;        &lt;list&gt;        &lt;dbl&gt;              &lt;dbl&gt;    &lt;dbl&gt;   &lt;int&gt;   &lt;dbl&gt;
 1 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0170
 2 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0171
 3 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0171
 4 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0170
 5 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0170
 6 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0170
 7 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0170
 8 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0170
 9 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0170
10 &lt;int [1,132]&gt; &lt;dbl [1,132]&gt;  1132               0.95    0.950    1303  0.0170
# … with abbreviated variable names ¹​top_feaure, ²​top_feature_alpha</code></pre>
<pre class="r"><code>cs_tbl(ser.default)</code></pre>
<pre><code># A tibble: 1 × 7
# Rowwise: 
  cs            prob           size requested_coverage coverage top_fe…¹ top_f…²
  &lt;list&gt;        &lt;list&gt;        &lt;dbl&gt;              &lt;dbl&gt;    &lt;dbl&gt;    &lt;int&gt;   &lt;dbl&gt;
1 &lt;int [1,088]&gt; &lt;dbl [1,088]&gt;  1088               0.95    0.950      773  0.0769
# … with abbreviated variable names ¹​top_feaure, ²​top_feature_alpha</code></pre>
<p>The default initialization with a fixed prior variance puts a little
weight on the top marginal enrichments, but the ELBO is not better than
the null model, consequently when we optimize the prior variance we move
towards the null model.</p>
<pre class="r"><code>par(mfrow=c(1,1))
sort(fit.default$pip, decreasing = T) %&gt;% head(10)</code></pre>
<pre><code>    M27372       M546     M29844       M522     M26955       M706     M27410 
0.15795288 0.15553171 0.15480183 0.11390707 0.09481334 0.08853001 0.08756025 
      M653     M27412     M19248 
0.08743512 0.06573662 0.06272065 </code></pre>
<pre class="r"><code>plot(log10(fit.default$pip), -log10(ora$pFishersExact))</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/pip_v_p-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-pip_v_p-1">
Past versions of pip_v_p-1.png
</button>
</p>
<div id="fig-pip_v_p-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/pip_v_p-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code># prior variances shrunk towards 0
fit.default2$V</code></pre>
<pre><code> [1] 0.006038130 0.006042149 0.006042500 0.006042866 0.006043241 0.006043623
 [7] 0.006044010 0.006044401 0.006044797 0.006045197</code></pre>
<pre class="r"><code>par(mfrow=c(1,1))
sort(ser.default$pip, decreasing = T) %&gt;% head(10)</code></pre>
<pre><code>      M546     M27372     M27410       M522     M29844     M27412     M19248 
0.07687629 0.03959879 0.03249380 0.02652192 0.02584373 0.02235149 0.01267343 
      M556     M27303     M27416 
0.01197180 0.01163170 0.01158728 </code></pre>
<pre class="r"><code>plot(log10(ser.default$pip), -log10(ora$pFishersExact))</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/pip_v_p2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-pip_v_p2-1">
Past versions of pip_v_p2-1.png
</button>
</p>
<div id="fig-pip_v_p2-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/pip_v_p2-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code># prior variances shrunk towards 0
ser.default$V</code></pre>
<pre><code>[1] 10</code></pre>
<pre class="r"><code>get_elbo(ser.default)</code></pre>
<pre><code>[1] -810.7019</code></pre>
<pre class="r"><code>get_elbo(ser.default2)</code></pre>
<pre><code>[1] -809.697</code></pre>
</div>
<div id="fit-at-many-fixed-values-of-sigma_02" class="section level3">
<h3>Fit at many fixed values of <span
class="math inline">\(\sigma_0^2\)</span></h3>
<pre class="r"><code>tic(&#39;SER, prior variance grid&#39;)
prior_variance_grid &lt;- c(0.01, 0.1, 0.2, 0.5, 1, 2, 5, 10)
ser.grid &lt;- cache_rds(with(bindata, map(
  prior_variance_grid, ~binsusie(X, y, L = 1, prior_variance = .x, estimate_prior_variance = F))), file=&#39;ser.vary_sigma0&#39;)
toc()</code></pre>
<pre><code>SER, prior variance grid: 2.251 sec elapsed</code></pre>
<pre class="r"><code>plot(prior_variance_grid, map_dbl(ser.grid, get_elbo), type=&#39;l&#39;,
     xlab=&#39;Fixed prior variance&#39;, ylab=&#39;ELBO&#39;,
     main=&#39;Default initialization optimized to ELBO&#39;)
abline(v=0, col=&#39;red&#39;, lty=2)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/prior_variance_variance_grid-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-prior_variance_variance_grid-1">
Past versions of prior_variance_variance_grid-1.png
</button>
</p>
<div id="fig-prior_variance_variance_grid-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/prior_variance_variance_grid-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="vb-ser" class="section level3">
<h3>VB-SER</h3>
<p>For the logistic SER we can fit a univariate regression to each gene
set and achieve a fairly tight bound on the BF with the PG/JJ
variational bound. We can use these approximate BFs to get more accurate
PIPs. We call this VB-SER. The VB-SER yields a 95% credible set with 15
gene sets. There is generally strong correlation between p-values from
the marignal analysis and PIPs (which are proportion to the BFs).
Furthermore, the VB-SER has a favorable BF (~16) against the null model,
whereas the logistic SER did not.</p>
<p>What’s going on here? Before we observed that the logistic SER
produces credible sets that under-cover, yet here we are seeing a that
the VB-SER produces a smaller credible set and a better fit to the
data.</p>
<p><span class="math display">\[
BF_{SER} = \sum BF_i \pi_i = \sum \alpha_i \log BF_i -
D_{KL}(Cat(\alpha) || Cat(\pi))
\]</span></p>
<p>If there is more than one signal in the data we actually get a
stronger <span class="math inline">\(BF_{SER}\)</span>. Suppose we have
two strong candidates for the single effect with equal BFs so that all
of the posterior mass is distributed equally among theses two, and
contrast it with the situation where there is exactly one strong
candidate and <span class="math inline">\(\alpha = e_i\)</span> for some
<span class="math inline">\(i\)</span>. The sum of <span
class="math inline">\(BFs\)</span> is the same, but when there are
multiple strong candidates the posterior probabilities <span
class="math inline">\(\alpha\)</span> are closer the the prior. We pay
$p - $ instead of <span class="math inline">\(\log p\)</span>. While the
model is mis-specified, it’s mispsecified in such that there are many
ways for the SER to be “right”.</p>
<p>The logistic SER does not necessarily benefit as much from this
effect– in the extreme our approximation biases us towards solutions
where <span class="math inline">\(\alpha\)</span> is overly concentrated
on one feature, say <span class="math inline">\(i\)</span>. But if <span
class="math inline">\(BF_i &lt; p\)</span> we would favor the null
model.</p>
<pre class="r"><code>tic(&#39;Fitting VB SER&#39;)
uvb_ser &lt;- cache_rds(with(bindata, fit_uvb_ser(
  X, y, prior_variance = 10)), file=&#39;uvb_ser&#39;)
uvb_ser_centered &lt;- cache_rds(with(bindata, fit_uvb_ser(
  scale(X, scale=F), y, prior_variance = 10)), file=&#39;uvb_ser_centered&#39;)
toc()</code></pre>
<pre><code>Fitting VB SER: 0.006 sec elapsed</code></pre>
<pre class="r"><code>vb_cs &lt;- get_cs(uvb_ser$alpha)
vb_cs$cs</code></pre>
<pre><code> [1]  197  195  193  773  479  200   16  623  772 1303  315  291  288  657  607</code></pre>
<pre class="r"><code>intersection &lt;- intersect(marginal_idx, vb_cs$cs)
paste0(length(intersection), &#39;/&#39;, length(marginal_idx), &#39; CS gene sets are significant at FDR &lt; 0.05&#39;)</code></pre>
<pre><code>[1] &quot;14/16 CS gene sets are significant at FDR &lt; 0.05&quot;</code></pre>
<pre class="r"><code>sort(uvb_ser$alpha, decreasing = T) %&gt;% head(10)</code></pre>
<pre><code> [1] 0.279814784 0.245246456 0.212558639 0.095986523 0.037847754 0.023818456
 [7] 0.012335319 0.010708397 0.009559646 0.006471612</code></pre>
<pre class="r"><code>par(mfrow=c(1,1))
plot(-log10(ora$pFishersExact), log10(uvb_ser$alpha), xlab=&#39;-log10(p)&#39;, ylab=&#39;log10(PIP)&#39;)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/vb-ser-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-vb-ser-1">
Past versions of vb-ser-1.png
</button>
</p>
<div id="fig-vb-ser-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/vb-ser-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/6728f824474066744b11556e451965d441e3a977/docs/figure/logistic_susie_initialization.Rmd/vb-ser-1.png" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code># BF
p &lt;- length(uvb_ser$lbf)
pi &lt;- rep(1/p, p)
exp(matrixStats::logSumExp(uvb_ser$lbf + log(pi)))</code></pre>
<pre><code>[1] 16.24167</code></pre>
<pre class="r"><code># equivalently
exp(sum(uvb_ser$lbf * uvb_ser$alpha) - categorical_kl(uvb_ser$alpha, pi))</code></pre>
<pre><code>[1] 16.24167</code></pre>
<pre class="r"><code>exp(get_elbo(ser.default) - get_elbo(ser.null))</code></pre>
<pre><code>[1] 0.3589507</code></pre>
<p>Here we take the UVB solution and optimize <span
class="math inline">\(\xi\)</span> while holding <span
class="math inline">\(q(\beta)\)</span> fixed…</p>
<pre class="r"><code>vb_elbo_uvb_fit &lt;- ser.null

vb_elbo_uvb_fit$params$mu[1,] &lt;- uvb_ser$mu
vb_elbo_uvb_fit$params$var[1,] &lt;- uvb_ser$var
vb_elbo_uvb_fit$params$alpha[1,] &lt;- uvb_ser$alpha
vb_elbo_uvb_fit$params$delta[1,1] &lt;- sum(uvb_ser$intercept * uvb_ser$alpha)
vb_elbo_uvb_fit$hypers$prior_variance &lt;- uvb_ser$prior_variance
vb_elbo_uvb_fit &lt;- set_xi(vb_elbo_uvb_fit, update_xi.binsusie(vb_elbo_uvb_fit))
vb_elbo_uvb_fit &lt;- fit.binsusie(vb_elbo_uvb_fit, fit_prior_variance = F, fit_xi=T, fit_alpha = F)</code></pre>
<pre><code>Warning in .diff(fit): ELBO decreased</code></pre>
<pre class="r"><code>cs_tbl(vb_elbo_uvb_fit)</code></pre>
<pre><code># A tibble: 1 × 7
# Rowwise: 
  cs         prob        size requested_coverage coverage top_feaure top_featu…¹
  &lt;list&gt;     &lt;list&gt;     &lt;dbl&gt;              &lt;dbl&gt;    &lt;dbl&gt;      &lt;int&gt;       &lt;dbl&gt;
1 &lt;int [15]&gt; &lt;dbl [15]&gt;    15               0.95    0.951        197       0.280
# … with abbreviated variable name ¹​top_feature_alpha</code></pre>
<pre class="r"><code>compute_elbo.binsusie(vb_elbo_uvb_fit) - get_elbo(fit.null)</code></pre>
<pre><code>[1] -4.156101</code></pre>
<pre class="r"><code>uvb_ser$lbf_model</code></pre>
<pre><code>[1] 2.78758</code></pre>
</div>
<div id="fixed-qomega-initializtion" class="section level3">
<h3>Fixed <span class="math inline">\(q(\omega)\)</span>
initializtion</h3>
<p>The setting of the PG variational parameters is critical to the
model. The variational approximation is tightest when <span
class="math inline">\(\xi_i = \mathbb E[(x_i^Tb)^2]\)</span>. We explore
the impact of the variational parameters <span
class="math inline">\(\xi\)</span> by fixing them to their optimal value
<em>for a particular gene set</em>.</p>
<p>We say that the uni-variate VB SER detects lots of strong signal.
What if we initialize <span class="math inline">\(q(\omega)\)</span>
using one of these? Let’s find out.</p>
<pre class="r"><code># indices with large positive log BFs
bf_order &lt;- order(desc(uvb_ser$lbf))

# all the gene sets in the VB SER credible set have strong evidence of association
tibble(geneSet = gs_names[vb_cs$cs], idx=vb_cs$cs, BF = exp(uvb_ser$lbf[vb_cs$cs])) %&gt;% 
  left_join(ora) %&gt;%
  kbl(caption=&#39;Marginal Enrichments&#39;) %&gt;% kable_styling()</code></pre>
<pre><code>Joining, by = &quot;geneSet&quot;</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
Marginal Enrichments
</caption>
<thead>
<tr>
<th style="text-align:left;">
geneSet
</th>
<th style="text-align:right;">
idx
</th>
<th style="text-align:right;">
BF
</th>
<th style="text-align:right;">
geneListSize
</th>
<th style="text-align:right;">
geneSetSize
</th>
<th style="text-align:right;">
overlap
</th>
<th style="text-align:right;">
nGenes
</th>
<th style="text-align:right;">
propInList
</th>
<th style="text-align:right;">
propInSet
</th>
<th style="text-align:right;">
oddsRatio
</th>
<th style="text-align:right;">
pHypergeometric
</th>
<th style="text-align:right;">
pFishersExact
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
M5336
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
6044.39788
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
397
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.9999971
</td>
<td style="text-align:right;">
0.0000056
</td>
</tr>
<tr>
<td style="text-align:left;">
M543
</td>
<td style="text-align:right;">
195
</td>
<td style="text-align:right;">
5297.67275
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
488
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0055249
</td>
<td style="text-align:right;">
0.0020492
</td>
<td style="text-align:right;">
0.0599932
</td>
<td style="text-align:right;">
0.9999999
</td>
<td style="text-align:right;">
0.0000057
</td>
</tr>
<tr>
<td style="text-align:left;">
M522
</td>
<td style="text-align:right;">
193
</td>
<td style="text-align:right;">
4591.56935
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
75
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0662983
</td>
<td style="text-align:right;">
0.1600000
</td>
<td style="text-align:right;">
6.4051846
</td>
<td style="text-align:right;">
0.0000022
</td>
<td style="text-align:right;">
0.0000022
</td>
</tr>
<tr>
<td style="text-align:left;">
M546
</td>
<td style="text-align:right;">
773
</td>
<td style="text-align:right;">
2073.44560
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
35
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0441989
</td>
<td style="text-align:right;">
0.2285714
</td>
<td style="text-align:right;">
9.7949047
</td>
<td style="text-align:right;">
0.0000075
</td>
<td style="text-align:right;">
0.0000075
</td>
</tr>
<tr>
<td style="text-align:left;">
M706
</td>
<td style="text-align:right;">
479
</td>
<td style="text-align:right;">
817.56539
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
62
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0552486
</td>
<td style="text-align:right;">
0.1612903
</td>
<td style="text-align:right;">
6.4035088
</td>
<td style="text-align:right;">
0.0000149
</td>
<td style="text-align:right;">
0.0000149
</td>
</tr>
<tr>
<td style="text-align:left;">
M19248
</td>
<td style="text-align:right;">
200
</td>
<td style="text-align:right;">
514.51257
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
53
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0497238
</td>
<td style="text-align:right;">
0.1698113
</td>
<td style="text-align:right;">
6.7809197
</td>
<td style="text-align:right;">
0.0000263
</td>
<td style="text-align:right;">
0.0000263
</td>
</tr>
<tr>
<td style="text-align:left;">
M5907
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
266.46047
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
145
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0828729
</td>
<td style="text-align:right;">
0.1034483
</td>
<td style="text-align:right;">
3.9036145
</td>
<td style="text-align:right;">
0.0000309
</td>
<td style="text-align:right;">
0.0000309
</td>
</tr>
<tr>
<td style="text-align:left;">
M27662
</td>
<td style="text-align:right;">
623
</td>
<td style="text-align:right;">
231.31663
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
287
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.9998913
</td>
<td style="text-align:right;">
0.0002637
</td>
</tr>
<tr>
<td style="text-align:left;">
M27416
</td>
<td style="text-align:right;">
772
</td>
<td style="text-align:right;">
206.50197
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
47
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0441989
</td>
<td style="text-align:right;">
0.1702128
</td>
<td style="text-align:right;">
6.7668593
</td>
<td style="text-align:right;">
0.0000735
</td>
<td style="text-align:right;">
0.0000735
</td>
</tr>
<tr>
<td style="text-align:left;">
M27372
</td>
<td style="text-align:right;">
1303
</td>
<td style="text-align:right;">
139.79603
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0220994
</td>
<td style="text-align:right;">
0.3636364
</td>
<td style="text-align:right;">
18.5278450
</td>
<td style="text-align:right;">
0.0002347
</td>
<td style="text-align:right;">
0.0002347
</td>
</tr>
<tr>
<td style="text-align:left;">
M27303
</td>
<td style="text-align:right;">
315
</td>
<td style="text-align:right;">
103.25054
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
29
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0331492
</td>
<td style="text-align:right;">
0.2068966
</td>
<td style="text-align:right;">
8.5311801
</td>
<td style="text-align:right;">
0.0001974
</td>
<td style="text-align:right;">
0.0001974
</td>
</tr>
<tr>
<td style="text-align:left;">
M27410
</td>
<td style="text-align:right;">
291
</td>
<td style="text-align:right;">
93.98490
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0220994
</td>
<td style="text-align:right;">
0.3333333
</td>
<td style="text-align:right;">
16.2090395
</td>
<td style="text-align:right;">
0.0003437
</td>
<td style="text-align:right;">
0.0003437
</td>
</tr>
<tr>
<td style="text-align:left;">
M27412
</td>
<td style="text-align:right;">
288
</td>
<td style="text-align:right;">
65.75229
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0220994
</td>
<td style="text-align:right;">
0.3076923
</td>
<td style="text-align:right;">
14.4055242
</td>
<td style="text-align:right;">
0.0004846
</td>
<td style="text-align:right;">
0.0004846
</td>
</tr>
<tr>
<td style="text-align:left;">
M16843
</td>
<td style="text-align:right;">
657
</td>
<td style="text-align:right;">
53.48257
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
470
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0165746
</td>
<td style="text-align:right;">
0.0063830
</td>
<td style="text-align:right;">
0.1905180
</td>
<td style="text-align:right;">
0.9999633
</td>
<td style="text-align:right;">
0.0003866
</td>
</tr>
<tr>
<td style="text-align:left;">
M29844
</td>
<td style="text-align:right;">
607
</td>
<td style="text-align:right;">
50.05587
</td>
<td style="text-align:right;">
181
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
5927
</td>
<td style="text-align:right;">
0.0165746
</td>
<td style="text-align:right;">
0.4285714
</td>
<td style="text-align:right;">
24.1938202
</td>
<td style="text-align:right;">
0.0008955
</td>
<td style="text-align:right;">
0.0008955
</td>
</tr>
</tbody>
</table>
<pre class="r"><code># use ELBO - null_elbo is an approximate BF. Not much variation to model in the null elbo so it is tight.
null_elbo &lt;- with(bindata, tail(fit_univariate_vb(X[, 1], y, tau0=1e10)$elbos, 1))
null_ser &lt;- with(bindata, binsusie(X, y, L=1, prior_variance = 1e-10))
null_ser_elbo &lt;- get_elbo(null_ser)</code></pre>
</div>
<div id="fixing-xi" class="section level3">
<h3>Fixing <span class="math inline">\(\xi\)</span></h3>
<p>First let’s do something where we know what will happen. Above we
have fit the univariate VB logistic regression for each gene set. Each
of gene set <span class="math inline">\(i\)</span> we have set of
variational parameters <span class="math inline">\(\xi^{(i)}\)</span>
which parameterize <span class="math inline">\(q(\omega; \xi)\)</span>,
the approximate posterior of the latent polya-gamma variables. As we’ve
discussed, for a fixed <span class="math inline">\(\xi^{(i)}\)</span>
the bound will be tightest for gene set/feature <span
class="math inline">\(i\)</span> and the bound will become progressively
worse for another gene set. If we try and fit the single effect
regression fixing <span class="math inline">\(q(\omega) = q(\omega;
\xi^{(i)})\)</span>, we should expect, at least when gene set <span
class="math inline">\(i\)</span> is predictive that we select that gene
set.</p>
<p>The ELBO for these fits is predictable also:</p>
<p><span class="math display">\[
ELBO_{SER} \leq \sum_j \alpha_j \left(ELBO_j -
\log\frac{\alpha_j}{\pi_j}\right)
\]</span></p>
<p>Assuming our solution puts most of it’s posterior mass on selection
feature <span class="math inline">\(i\)</span> (since we have rigged it
encourage this outcome)</p>
<p><span class="math display">\[
ELBO_{SER} \approx ELBO_i - \log p
\]</span></p>
<p>What’s the point of this? We see that we can “recover” the logistic
SER. With a specific initialization we can fit the ELBO to a local
optima that is better than what we found with the default initialization
(<code>fixed_vs_default &gt; 0</code> gives the difference in ELBOs) for
the top 10 marginal enrichments. Furthermore, the new SER fits give
favorable BFs for the top 4 marginal enrichments</p>
<pre class="r"><code>#&#39; Take a binsusie fit with L=1 and flatten to an SER fit
flatten_binsusie &lt;- function(fit){
  fit$params$alpha &lt;- fit$params$alpha[1,]
  fit$params$mu &lt;- fit$params$mu[1,]
  fit$params$var &lt;- fit$params$var[1,]
  fit$params$delta &lt;- fit$params$delta[1,1]
  return(fit)
}

fixed_xi_ser &lt;- function(idx){
  uvb &lt;- with(bindata, fit_univariate_vb(X[, idx], y, 0, tau=1/10))
  fit.init &lt;- with(bindata, binsusie_init(X, y, L = 1, center = T, prior_variance = 10))
  fit.init &lt;- set_xi(fit.init, uvb$xi)
  fit &lt;- fit.binsusie(fit.init, fit_xi = F, fit_prior_variance = F, fast_elbo = F) %&gt;% binsusie_wrapup()
  
  lbf &lt;- fit %&gt;% flatten_binsusie() %&gt;% compute_elbo_idx(idx=idx) %&gt;% {. - null_elbo}

  res &lt;- list(
    geneSet = gs_names[idx],
    vb_lbf_model = get_bf(fit),
    vb_lbf_var = lbf,
    uvb_lbf_model = uvb_ser$lbf_model,
    uvb_lbf_var = uvb_ser$lbf[[idx]],
    fixed_vs_default = tail(fit$elbo, 1) - null_ser_elbo,
    init_idx = idx
  )
  res &lt;- c(res, get_cs(fit$pip))
  return(res)
}

res &lt;- cache_rds({
  map(bf_order[1:20], fixed_xi_ser) %&gt;%
      tibble() %&gt;%
      unnest_wider(1)
  }, file=&#39;fixed_xi&#39;)
res %&gt;% 
  rowwise() %&gt;%
  mutate(cs_size = length(cs)) %&gt;%
  mutate(cs = list(head(cs, 5)), prob=list(head(prob, 5))) %&gt;%
  kbl(caption=&#39;Fixed at optimal xi&#39;) %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
Fixed at optimal xi
</caption>
<thead>
<tr>
<th style="text-align:left;">
geneSet
</th>
<th style="text-align:right;">
vb_lbf_model
</th>
<th style="text-align:right;">
vb_lbf_var
</th>
<th style="text-align:right;">
uvb_lbf_model
</th>
<th style="text-align:right;">
uvb_lbf_var
</th>
<th style="text-align:right;">
fixed_vs_default
</th>
<th style="text-align:right;">
init_idx
</th>
<th style="text-align:left;">
cs
</th>
<th style="text-align:left;">
prob
</th>
<th style="text-align:right;">
size
</th>
<th style="text-align:right;">
requested_coverage
</th>
<th style="text-align:right;">
coverage
</th>
<th style="text-align:right;">
cs_size
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
M5336
</td>
<td style="text-align:right;">
1.5293569
</td>
<td style="text-align:right;">
8.722291
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
8.706887
</td>
<td style="text-align:right;">
1.5299587
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:left;">
197
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M543
</td>
<td style="text-align:right;">
1.4026200
</td>
<td style="text-align:right;">
8.595554
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
8.575023
</td>
<td style="text-align:right;">
1.4032219
</td>
<td style="text-align:right;">
195
</td>
<td style="text-align:left;">
195
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M522
</td>
<td style="text-align:right;">
1.2494742
</td>
<td style="text-align:right;">
8.440692
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
8.431977
</td>
<td style="text-align:right;">
1.2500761
</td>
<td style="text-align:right;">
193
</td>
<td style="text-align:left;">
193
</td>
<td style="text-align:left;">
0.9982852
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9982852
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M546
</td>
<td style="text-align:right;">
0.4658228
</td>
<td style="text-align:right;">
7.641241
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
7.636967
</td>
<td style="text-align:right;">
0.4664247
</td>
<td style="text-align:right;">
773
</td>
<td style="text-align:left;">
773
</td>
<td style="text-align:left;">
0.9826363
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9826363
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M706
</td>
<td style="text-align:right;">
-0.4792843
</td>
<td style="text-align:right;">
6.713566
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
6.706331
</td>
<td style="text-align:right;">
-0.4786824
</td>
<td style="text-align:right;">
479
</td>
<td style="text-align:left;">
479
</td>
<td style="text-align:left;">
0.9999159
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9999159
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M19248
</td>
<td style="text-align:right;">
-0.4787732
</td>
<td style="text-align:right;">
6.249460
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
6.243220
</td>
<td style="text-align:right;">
-0.4781713
</td>
<td style="text-align:right;">
200
</td>
<td style="text-align:left;">
200, 193
</td>
<td style="text-align:left;">
0.6283199, 0.3714622
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9997821
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
M5907
</td>
<td style="text-align:right;">
-1.5918060
</td>
<td style="text-align:right;">
5.601127
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
5.585226
</td>
<td style="text-align:right;">
-1.5912041
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:left;">
16
</td>
<td style="text-align:left;">
0.9999992
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9999992
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M27662
</td>
<td style="text-align:right;">
-1.7384888
</td>
<td style="text-align:right;">
5.454445
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
5.443788
</td>
<td style="text-align:right;">
-1.7378870
</td>
<td style="text-align:right;">
623
</td>
<td style="text-align:left;">
623
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M27416
</td>
<td style="text-align:right;">
-1.2253481
</td>
<td style="text-align:right;">
5.335733
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
5.330310
</td>
<td style="text-align:right;">
-1.2247462
</td>
<td style="text-align:right;">
772
</td>
<td style="text-align:left;">
772, 773
</td>
<td style="text-align:left;">
0.5316036, 0.4656237
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9972273
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
M27372
</td>
<td style="text-align:right;">
-2.1036253
</td>
<td style="text-align:right;">
4.941676
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
4.940184
</td>
<td style="text-align:right;">
-2.1030235
</td>
<td style="text-align:right;">
1303
</td>
<td style="text-align:left;">
1303, 193, 200, 773, 607
</td>
<td style="text-align:left;">
0.862746349, 0.044224912, 0.028149593, 0.003076114, 0.001860440
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9501099
</td>
<td style="text-align:right;">
20
</td>
</tr>
<tr>
<td style="text-align:left;">
M27303
</td>
<td style="text-align:right;">
-2.4304182
</td>
<td style="text-align:right;">
4.640739
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
4.637158
</td>
<td style="text-align:right;">
-2.4298164
</td>
<td style="text-align:right;">
315
</td>
<td style="text-align:left;">
315, 772, 773
</td>
<td style="text-align:left;">
0.88534348, 0.04577195, 0.03158688
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9627023
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
M27410
</td>
<td style="text-align:right;">
-1.7548880
</td>
<td style="text-align:right;">
4.544624
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
4.543134
</td>
<td style="text-align:right;">
-1.7542862
</td>
<td style="text-align:right;">
291
</td>
<td style="text-align:left;">
291, 773, 288, 1203, 286
</td>
<td style="text-align:left;">
0.4092523, 0.2511493, 0.1403995, 0.0542337, 0.0542337
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9629605
</td>
<td style="text-align:right;">
7
</td>
</tr>
<tr>
<td style="text-align:left;">
M27412
</td>
<td style="text-align:right;">
-1.8213821
</td>
<td style="text-align:right;">
4.187476
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
4.185894
</td>
<td style="text-align:right;">
-1.8207803
</td>
<td style="text-align:right;">
288
</td>
<td style="text-align:left;">
773, 288, 291, 315, 286
</td>
<td style="text-align:left;">
0.31200784, 0.30602848, 0.19330725, 0.04667171, 0.04384247
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9645430
</td>
<td style="text-align:right;">
7
</td>
</tr>
<tr>
<td style="text-align:left;">
M16843
</td>
<td style="text-align:right;">
-3.1870179
</td>
<td style="text-align:right;">
4.005916
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.979356
</td>
<td style="text-align:right;">
-3.1864161
</td>
<td style="text-align:right;">
657
</td>
<td style="text-align:left;">
657
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M29844
</td>
<td style="text-align:right;">
-2.6758762
</td>
<td style="text-align:right;">
3.913617
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.913140
</td>
<td style="text-align:right;">
-2.6752744
</td>
<td style="text-align:right;">
607
</td>
<td style="text-align:left;">
607, 773, 1303, 291, 193
</td>
<td style="text-align:left;">
0.54692564, 0.02086429, 0.01713422, 0.01106980, 0.01017004
</td>
<td style="text-align:right;">
922
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9500266
</td>
<td style="text-align:right;">
922
</td>
</tr>
<tr>
<td style="text-align:left;">
M27958
</td>
<td style="text-align:right;">
-3.2977463
</td>
<td style="text-align:right;">
3.883123
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.879082
</td>
<td style="text-align:right;">
-3.2971445
</td>
<td style="text-align:right;">
108
</td>
<td style="text-align:left;">
108
</td>
<td style="text-align:left;">
0.9880071
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9880071
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M653
</td>
<td style="text-align:right;">
-3.0825651
</td>
<td style="text-align:right;">
3.863291
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.861552
</td>
<td style="text-align:right;">
-3.0819633
</td>
<td style="text-align:right;">
1180
</td>
<td style="text-align:left;">
1180, 479, 773, 1303, 607
</td>
<td style="text-align:left;">
0.781077674, 0.085520530, 0.005802611, 0.004800204, 0.003521299
</td>
<td style="text-align:right;">
351
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9500234
</td>
<td style="text-align:right;">
351
</td>
</tr>
<tr>
<td style="text-align:left;">
M27483
</td>
<td style="text-align:right;">
-2.4849526
</td>
<td style="text-align:right;">
3.566544
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.564866
</td>
<td style="text-align:right;">
-2.4843508
</td>
<td style="text-align:right;">
286
</td>
<td style="text-align:left;">
286, 291, 773, 288, 1203
</td>
<td style="text-align:left;">
0.31935874, 0.22833358, 0.16703309, 0.13402003, 0.05300413
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9502471
</td>
<td style="text-align:right;">
17
</td>
</tr>
<tr>
<td style="text-align:left;">
M556
</td>
<td style="text-align:right;">
-1.9604577
</td>
<td style="text-align:right;">
3.566644
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.564866
</td>
<td style="text-align:right;">
-1.9598559
</td>
<td style="text-align:right;">
1203
</td>
<td style="text-align:left;">
773, 1203, 291, 288, 286
</td>
<td style="text-align:left;">
0.48732969, 0.18903288, 0.13514238, 0.07932011, 0.03136961
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9647664
</td>
<td style="text-align:right;">
7
</td>
</tr>
<tr>
<td style="text-align:left;">
M13087
</td>
<td style="text-align:right;">
-3.8527462
</td>
<td style="text-align:right;">
3.340185
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.332543
</td>
<td style="text-align:right;">
-3.8521443
</td>
<td style="text-align:right;">
860
</td>
<td style="text-align:left;">
860
</td>
<td style="text-align:left;">
0.9999969
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9999969
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
</div>
<div id="estimate-xi" class="section level3">
<h3>Estimate <span class="math inline">\(\xi\)</span></h3>
<p>Next we take these fits initialized at each <span
class="math inline">\(\xi^{(i)}\)</span> and allow them to optimize over
the <span class="math inline">\(\xi\)</span> and the prior variance
parameter. For at least the top 9 marginal encroachments, the
“preferred” gene set is included in the credible set.</p>
<pre class="r"><code>init_xi_ser &lt;- function(idx){
  uvb &lt;- with(bindata, fit_univariate_vb(X[, idx], y, 0, tau=1/10))
  fit.init &lt;- with(bindata, binsusie_init(X, y, L = 1, center = T, prior_variance = 10))
  fit.init &lt;- set_xi(fit.init, uvb$xi)
  fit &lt;- fit.binsusie(fit.init, fit_xi = F, fit_prior_variance = F, fast_elbo = F)
  fit &lt;- fit.binsusie(fit, fit_xi=T, fit_prior_variance = T, maxiter = 100, fast_elbo = F) %&gt;% binsusie_wrapup()

  lbf &lt;- fit %&gt;% flatten_binsusie() %&gt;% compute_elbo_idx(idx=idx) %&gt;% {. - null_elbo}

  res &lt;- list(
    geneSet = gs_names[idx],
    vb_lbf_model = get_bf(fit),
    vb_lbf_var = lbf,
    uvb_lbf_model = uvb_ser$lbf_model,
    uvb_lbf_var = uvb_ser$lbf[[idx]],
    fixed_vs_default = tail(fit$elbo, 1) - null_ser_elbo,
    init_idx = idx
  )
  res &lt;- c(res, get_cs(fit$pip))
  return(res)
}

res2 &lt;- cache_rds({
  map(bf_order[1:20], init_xi_ser) %&gt;%
    tibble() %&gt;%
    unnest_wider(1)
  }, file=&#39;init_xi&#39;)
res2 %&gt;% 
  rowwise() %&gt;%
  mutate(cs_size = length(cs)) %&gt;%
  mutate(cs = list(head(cs, 5)), prob=list(head(prob, 5))) %&gt;%
  kbl(caption=&#39;Initialize with optimal xi&#39;) %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
Initialize with optimal xi
</caption>
<thead>
<tr>
<th style="text-align:left;">
geneSet
</th>
<th style="text-align:right;">
vb_lbf_model
</th>
<th style="text-align:right;">
vb_lbf_var
</th>
<th style="text-align:right;">
uvb_lbf_model
</th>
<th style="text-align:right;">
uvb_lbf_var
</th>
<th style="text-align:right;">
fixed_vs_default
</th>
<th style="text-align:right;">
init_idx
</th>
<th style="text-align:left;">
cs
</th>
<th style="text-align:left;">
prob
</th>
<th style="text-align:right;">
size
</th>
<th style="text-align:right;">
requested_coverage
</th>
<th style="text-align:right;">
coverage
</th>
<th style="text-align:right;">
cs_size
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
M5336
</td>
<td style="text-align:right;">
1.7313644
</td>
<td style="text-align:right;">
8.9242986
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
8.706887
</td>
<td style="text-align:right;">
1.7319663
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:left;">
197
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M543
</td>
<td style="text-align:right;">
1.4695822
</td>
<td style="text-align:right;">
8.6625164
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
8.575023
</td>
<td style="text-align:right;">
1.4701840
</td>
<td style="text-align:right;">
195
</td>
<td style="text-align:left;">
195
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M522
</td>
<td style="text-align:right;">
1.4663850
</td>
<td style="text-align:right;">
8.6573509
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
8.431977
</td>
<td style="text-align:right;">
1.4669869
</td>
<td style="text-align:right;">
193
</td>
<td style="text-align:left;">
193
</td>
<td style="text-align:left;">
0.9981069
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9981069
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M546
</td>
<td style="text-align:right;">
0.5650206
</td>
<td style="text-align:right;">
7.7372307
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
7.636967
</td>
<td style="text-align:right;">
0.5656224
</td>
<td style="text-align:right;">
773
</td>
<td style="text-align:left;">
773
</td>
<td style="text-align:left;">
0.979686
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9796860
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M706
</td>
<td style="text-align:right;">
-0.2601959
</td>
<td style="text-align:right;">
6.9326155
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
6.706331
</td>
<td style="text-align:right;">
-0.2595940
</td>
<td style="text-align:right;">
479
</td>
<td style="text-align:left;">
479
</td>
<td style="text-align:left;">
0.9998799
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9998799
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M19248
</td>
<td style="text-align:right;">
1.4657424
</td>
<td style="text-align:right;">
2.4793865
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
6.243220
</td>
<td style="text-align:right;">
1.4663443
</td>
<td style="text-align:right;">
200
</td>
<td style="text-align:left;">
193
</td>
<td style="text-align:left;">
0.9978976
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9978976
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M5907
</td>
<td style="text-align:right;">
-1.1375695
</td>
<td style="text-align:right;">
6.0553626
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
5.585226
</td>
<td style="text-align:right;">
-1.1369677
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:left;">
16
</td>
<td style="text-align:left;">
0.9999982
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9999982
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M27662
</td>
<td style="text-align:right;">
-1.6517980
</td>
<td style="text-align:right;">
5.5411362
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
5.443788
</td>
<td style="text-align:right;">
-1.6511962
</td>
<td style="text-align:right;">
623
</td>
<td style="text-align:left;">
623
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M27416
</td>
<td style="text-align:right;">
0.5644567
</td>
<td style="text-align:right;">
3.8634085
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
5.330310
</td>
<td style="text-align:right;">
0.5650585
</td>
<td style="text-align:right;">
772
</td>
<td style="text-align:left;">
773
</td>
<td style="text-align:left;">
0.9790268
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9790268
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M27372
</td>
<td style="text-align:right;">
-0.0217927
</td>
<td style="text-align:right;">
0.1134353
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
4.940184
</td>
<td style="text-align:right;">
-0.0211908
</td>
<td style="text-align:right;">
1303
</td>
<td style="text-align:left;">
193, 16, 732, 479, 195
</td>
<td style="text-align:left;">
0.001562797, 0.001484152, 0.001265542, 0.001264765, 0.001246985
</td>
<td style="text-align:right;">
1253
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9503635
</td>
<td style="text-align:right;">
1253
</td>
</tr>
<tr>
<td style="text-align:left;">
M27303
</td>
<td style="text-align:right;">
0.5636020
</td>
<td style="text-align:right;">
-2.2354362
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
4.637158
</td>
<td style="text-align:right;">
0.5642039
</td>
<td style="text-align:right;">
315
</td>
<td style="text-align:left;">
773
</td>
<td style="text-align:left;">
0.9790262
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9790262
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M27410
</td>
<td style="text-align:right;">
0.5637832
</td>
<td style="text-align:right;">
-1.3349779
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
4.543134
</td>
<td style="text-align:right;">
0.5643851
</td>
<td style="text-align:right;">
291
</td>
<td style="text-align:left;">
773
</td>
<td style="text-align:left;">
0.9791199
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9791199
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M27412
</td>
<td style="text-align:right;">
0.5639207
</td>
<td style="text-align:right;">
-1.4036071
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
4.185894
</td>
<td style="text-align:right;">
0.5645226
</td>
<td style="text-align:right;">
288
</td>
<td style="text-align:left;">
773
</td>
<td style="text-align:left;">
0.9791461
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9791461
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M16843
</td>
<td style="text-align:right;">
-2.8613673
</td>
<td style="text-align:right;">
4.3315669
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.979356
</td>
<td style="text-align:right;">
-2.8607655
</td>
<td style="text-align:right;">
657
</td>
<td style="text-align:left;">
657
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M29844
</td>
<td style="text-align:right;">
-0.0216674
</td>
<td style="text-align:right;">
0.0650379
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.913140
</td>
<td style="text-align:right;">
-0.0210656
</td>
<td style="text-align:right;">
607
</td>
<td style="text-align:left;">
193, 16, 732, 479, 195
</td>
<td style="text-align:left;">
0.001557084, 0.001479899, 0.001263796, 0.001261379, 0.001245893
</td>
<td style="text-align:right;">
1253
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9503270
</td>
<td style="text-align:right;">
1253
</td>
</tr>
<tr>
<td style="text-align:left;">
M27958
</td>
<td style="text-align:right;">
-0.0220394
</td>
<td style="text-align:right;">
0.1846094
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.879082
</td>
<td style="text-align:right;">
-0.0214375
</td>
<td style="text-align:right;">
108
</td>
<td style="text-align:left;">
193, 16, 479, 732, 195
</td>
<td style="text-align:left;">
0.001574094, 0.001492533, 0.001271455, 0.001268953, 0.001249102
</td>
<td style="text-align:right;">
1253
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9504351
</td>
<td style="text-align:right;">
1253
</td>
</tr>
<tr>
<td style="text-align:left;">
M653
</td>
<td style="text-align:right;">
-0.0220894
</td>
<td style="text-align:right;">
0.1036714
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.861552
</td>
<td style="text-align:right;">
-0.0214876
</td>
<td style="text-align:right;">
1180
</td>
<td style="text-align:left;">
193, 16, 479, 732, 195
</td>
<td style="text-align:left;">
0.001576392, 0.001494232, 0.001272815, 0.001269640, 0.001249526
</td>
<td style="text-align:right;">
1253
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9504496
</td>
<td style="text-align:right;">
1253
</td>
</tr>
<tr>
<td style="text-align:left;">
M27483
</td>
<td style="text-align:right;">
0.5638771
</td>
<td style="text-align:right;">
-3.1401155
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.564866
</td>
<td style="text-align:right;">
0.5644790
</td>
<td style="text-align:right;">
286
</td>
<td style="text-align:left;">
773
</td>
<td style="text-align:left;">
0.9791443
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9791443
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M556
</td>
<td style="text-align:right;">
0.5636034
</td>
<td style="text-align:right;">
-1.4562322
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.564866
</td>
<td style="text-align:right;">
0.5642052
</td>
<td style="text-align:right;">
1203
</td>
<td style="text-align:left;">
773
</td>
<td style="text-align:left;">
0.9790996
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9790996
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
M13087
</td>
<td style="text-align:right;">
-3.8266650
</td>
<td style="text-align:right;">
3.3662674
</td>
<td style="text-align:right;">
2.78758
</td>
<td style="text-align:right;">
3.332543
</td>
<td style="text-align:right;">
-3.8260632
</td>
<td style="text-align:right;">
860
</td>
<td style="text-align:left;">
860
</td>
<td style="text-align:left;">
0.9999981
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.9999981
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
</div>
<div id="initializing-with-good-predictions" class="section level3">
<h3>Initializing with good predictions</h3>
<div id="fix-xi" class="section level4">
<h4>Fix <span class="math inline">\(\xi\)</span></h4>
<p>Here we take the top few marginal enrichment and fit a a multivariate
regression using <code>glm</code>, we use the predictions + standard
errors to initialize <span class="math inline">\(\xi\)</span>. If we fit
the model holding <span class="math inline">\(\xi\)</span> fixed we see
that logistic SuSiE identifies a few of the strong marginal enrichment,
however the ELBO is worse than the null model.</p>
<p>Next we continue to fit the model, allowing updates for <span
class="math inline">\(\xi\)</span> and estimation of the prior variance
parameters. Now we beat the null model!</p>
<pre class="r"><code>top_bf &lt;- order(desc(uvb_ser$lbf))[1:10]
heatmap(cor(as.matrix(bindata$X[, top_bf])), scale=&#39;none&#39;)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/init_xi_glm-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-init_xi_glm-1">
Past versions of init_xi_glm-1.png
</button>
</p>
<div id="fig-init_xi_glm-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/init_xi_glm-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>fit_init_xi &lt;- cache_rds({
  glm_fit &lt;- with(bindata, glm(y ~ as.matrix(X[, top_bf]), family = &#39;binomial&#39;))
  pred &lt;- predict(glm_fit, se.fit = T)
  
  xi &lt;- sqrt(pred$fit^2 + pred$se.fit^2)
  xi[xi &gt; 10] &lt;- 10  # truncate

  fit.init &lt;- with(bindata, binsusie_init(X, y, L = 10, center = T, prior_variance = 10))
  fit.init &lt;- set_xi(fit.init, xi)  # set the predictions
  fit &lt;- fit.binsusie(fit.init, fit_xi = F, fit_prior_variance = F, fast_elbo = F) %&gt;% binsusie_wrapup()
  fit &lt;- fit.binsusie(fit, fit_xi = T, fit_prior_variance = T, maxiter = 100, tol = 1e-3) %&gt;% binsusie_wrapup()
}, file=&#39;init_xi_glm&#39;)

fit &lt;- fit_init_xi
.monotone(fit$elbo)</code></pre>
<pre><code>[1] TRUE</code></pre>
<pre class="r"><code>tail(fit$elbo, 1) - tail(fit.null$elbo, 1)</code></pre>
<pre><code>[1] 2.539613</code></pre>
<pre class="r"><code>unlist(fit$sets$cs)</code></pre>
<pre><code> L2  L3  L4  L5  L6 
197 193 773 479  16 </code></pre>
</div>
<div id="fix-alpha" class="section level4">
<h4>Fix <span class="math inline">\(\alpha\)</span></h4>
<p>An alternative approach would be the fix <span
class="math inline">\(\alpha\)</span></p>
<pre class="r"><code>fit_init_alpha &lt;- cache_rds({
  p &lt;- dim(bindata$X)[2]
  L &lt;- 10
  top_bf &lt;- order(desc(uvb_ser$lbf))[1:L]
  alpha_init &lt;- matrix(rep(0, p*L), nrow= L)
  for (l in 1:L){
    alpha_init[l, top_bf[l]] &lt;- 1
  }
  
  fit.init &lt;- with(bindata, binsusie_init(X, y, L = 10, center = T, prior_variance = 10))
  fit.init$params$alpha &lt;- alpha_init
  fit &lt;- fit.binsusie(
    fit.init, fit_xi = T, fit_prior_variance = F, fast_elbo = T, fit_alpha = F)
  .monotone(fit$elbo)

  fit &lt;- fit.binsusie(fit, fit_prior_variance = T, fast_elbo = T, maxiter = 100, tol = 1e-3) %&gt;% 
    binsusie_wrapup()
  .monotone(fit$elbo)
  
  fit
}, file=&#39;init_alpha_glm&#39;)


fit &lt;- fit_init_alpha
.monotone(fit$elbo)</code></pre>
<pre><code>[1] TRUE</code></pre>
<pre class="r"><code>compute_elbo2.binsusie(fit) - null_elbo</code></pre>
<pre><code>[1] 2.565335</code></pre>
<pre class="r"><code>unlist(fit$sets$cs)</code></pre>
<pre><code> L1  L3  L4  L5  L7 
197 193 773 479  16 </code></pre>
</div>
<div id="comparing-alpha-initialization-and-xi-initialization"
class="section level4">
<h4>Comparing <span class="math inline">\(\alpha\)</span> initialization
and <span class="math inline">\(\xi\)</span> initialization</h4>
<p>Whether we initialize with <span class="math inline">\(\xi\)</span>
or <span class="math inline">\(\alpha\)</span> we get similar solutions
here. Both improve on the null model, and eliminate redundancy as the
model chooses to include 5 of the top 10 marginally enriched gene sets,
the ones that are not selected are correlated with the ones that
are.</p>
<pre class="r"><code>unlist(fit_init_alpha$sets$cs)</code></pre>
<pre><code> L1  L3  L4  L5  L7 
197 193 773 479  16 </code></pre>
<pre class="r"><code>unlist(fit_init_xi$sets$cs)</code></pre>
<pre><code> L2  L3  L4  L5  L6 
197 193 773 479  16 </code></pre>
<pre class="r"><code>tail(fit_init_alpha$elbo, 1) - tail(fit.null$elbo, 1)</code></pre>
<pre><code>[1] 2.565937</code></pre>
<pre class="r"><code>tail(fit_init_xi$elbo, 1) - tail(fit.null$elbo, 1)</code></pre>
<pre><code>[1] 2.539613</code></pre>
<pre class="r"><code>par(mfrow=c(1,3))

this_plot &lt;- partial(plot, xlab=&#39;init xi&#39;, ylab=&#39;init alpha&#39;)
this_plot(fit_init_xi$params$xi, fit_init_alpha$params$xi, main=&#39;xi&#39;)
this_plot(compute_Xb.binsusie(fit_init_xi), compute_Xb.binsusie(fit_init_alpha), main=&#39;predictions&#39;)
this_plot(fit_init_xi$params$tau, fit_init_alpha$params$tau, main=&#39;tau&#39;)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-4-1">
Past versions of unnamed-chunk-4-1.png
</button>
</p>
<div id="fig-unnamed-chunk-4-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/unnamed-chunk-4-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>top_bf &lt;- order(desc(uvb_ser$lbf))[1:10]

heatmap(cor(
  as.matrix(bindata$X[, unlist(fit_init_xi$sets$cs)]),
  as.matrix(bindata$X[, top_bf])),
  scale = &#39;none&#39;
)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/unnamed-chunk-4-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-4-2">
Past versions of unnamed-chunk-4-2.png
</button>
</p>
<div id="fig-unnamed-chunk-4-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/unnamed-chunk-4-2.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="how-to-initialize" class="section level3">
<h3>How to initialize?</h3>
<p>Personally I favor initializing <span
class="math inline">\(\xi\)</span> since it is easier to set up the
initialization. We can initialize <span
class="math inline">\(\xi\)</span> by taking the top marginal enrichment
(e.g. any gene set with marginal evidence in favor of the alternative
hypothesis) and fitting a joint regression model. We don’t need to worry
about correlation among the included variables because we are interested
in the predictions, not the explanations. To see this point: two
perfectly correlated gene sets would have huge uncertainty in the
estimated effects but not the predictions.</p>
<p>If we wanted to initialize <span
class="math inline">\(\alpha\)</span>, we’d be forced to do some other
(perhaps cruder) variable selection, e.g. a forward selection procedure.
This may be more computationally demanding, and reduces logistic SuSiE
to basically “picking K”. I think also that I like the idea that it is
easier to get good predictions rather than good explanations– but that
generally good explanations will be consistent with the good
predictions. Initializing <span class="math inline">\(\xi\)</span> gives
logistic SuSiE the benefit of seeing what “good prediction” should look
like, and so we are likely to optimize to a “good” local optimum of the
ELBO.</p>
<p>A light-weight approach to initializing the model may be to 1. Screen
for suggestive marginal effects 2. Fit a joint model for across this
subset of gene sets/features 3. Initialize <span
class="math inline">\(\xi = \mathbb E[(X\beta)^2] \approx \hat \mu^2 +
\hat s^2\)</span> where <span class="math inline">\(\hat \mu_i =
x_i^T\hat \beta\)</span> and <span class="math inline">\(\hat
s_i\)</span> is the correspond standard error. 4. Pre-train the model
optimizing other parameters while holding <span
class="math inline">\(\xi\)</span> fixed. In a second stage of
optimization, optimize all parameters.</p>
</div>
<div id="not-all-good-initializations-beat-the-null-model"
class="section level3">
<h3>Not all “good” initializations beat the null model</h3>
<p>Here we use the “initialize <span class="math inline">\(\xi\)</span>”
strategy by starting with <span class="math inline">\(\xi\)</span> from
the unregularized logistic regression fit on <span
class="math inline">\(M= 1, 3, 5, 10, 20, 50\)</span> variables. We see
that not all of the final fits beat the null model ELBO. Furthermore,
the gene sets selected by each initialization do not seems to “escape”
the initialization– if we initialize with the the top <span
class="math inline">\(M\)</span> marginal enrichments the resulting fit
selects a subset of those top <span class="math inline">\(M\)</span>
enrichment’s.</p>
<p>So it seems that initializing the model may be as hard as fitting
it….</p>
<pre class="r"><code>init_xi_glm &lt;- function(X, y, marginal_scores, n_features=10, max_xi=10){
  top_bf &lt;- order(desc(marginal_scores))[1:n_features]
  glm_fit &lt;- glm(y ~ as.matrix(X[, top_bf]), family = &#39;binomial&#39;)
  pred &lt;- predict(glm_fit, se.fit = T)
  xi &lt;- sqrt(pred$fit^2 + pred$se.fit^2)
  xi[xi &gt; 10] &lt;- 10  # truncate
  return(list(
    xi=xi, mu=pred$fit, se=pred$se.fit)
  )
}

binsusie_fit_xi_init &lt;- function(X, y, marginal_scores, n_features=50, L=10, center=T, prior_variance=10){
  fit.init &lt;- binsusie_init(X, y, L = L, center = center, prior_variance = center)
  
  # initialize with (clipped) GLM predictions
  xi_init &lt;- init_xi_glm(X, y, marginal_scores, n_features=n_features)
  fit.init &lt;- set_xi(fit.init, xi_init$xi)  # set the predictions
  
  # warmup 
  fit &lt;- fit.binsusie(
    fit.init, fit_xi = F, fit_prior_variance = F, fast_elbo = F)

  # final fit
  fit &lt;- fit.binsusie(fit, fit_xi = T, fit_prior_variance = T, maxiter = 100, tol = 1e-3) %&gt;% binsusie_wrapup()
  .monotone(fit$elbo)
  print(tail(fit$elbo, 1) - tail(fit.null$elbo, 1))
  return(fit)
}</code></pre>
<pre class="r"><code>fit1 &lt;- cache_rds(with(bindata, binsusie_fit_xi_init(
  X, y, marginal_scores=uvb_ser$lbf, n_features=1)), file=&#39;init_xi_top1&#39;)
fit3 &lt;- cache_rds(with(bindata, binsusie_fit_xi_init(
  X, y, marginal_scores=uvb_ser$lbf, n_features=3)), file=&#39;init_xi_top3&#39;)
fit5 &lt;- cache_rds(with(bindata, binsusie_fit_xi_init(
  X, y, marginal_scores=uvb_ser$lbf, n_features=5)), file=&#39;init_xi_top5&#39;)
fit10 &lt;- cache_rds(with(bindata, binsusie_fit_xi_init(
  X, y, marginal_scores=uvb_ser$lbf, n_features=10)), file=&#39;init_xi_top10&#39;)
fit20 &lt;- cache_rds(with(bindata, binsusie_fit_xi_init(
  X, y, marginal_scores=uvb_ser$lbf, n_features=20)), file=&#39;init_xi_top20&#39;)
fit50 &lt;- cache_rds(with(bindata, binsusie_fit_xi_init(
  X, y, marginal_scores=uvb_ser$lbf, n_features=50)), file=&#39;init_xi_top50&#39;)</code></pre>
<pre class="r"><code>#&#39; remove the lth effect from a susie fit
#&#39; useful for computing the ELBO of the alternative nodel where b_l=0
remove_effect &lt;- function(fit, l=1){
  fit2 &lt;- fit
  fit2$params$alpha &lt;- fit2$params$alpha[-l,]
  fit2$params$mu &lt;- fit2$params$mu[-l,]
  fit2$params$var &lt;- fit2$params$var[-l,]
  fit2$params$delta &lt;- matrix(fit2$params$delta[-l,], ncol = 1)
  
  fit2$hypers$L &lt;- fit2$hypers$L - 1
  fit2$hypers$pi &lt;- fit2$hypers$pi[-l,]
  fit2$hypers$prior_mean &lt;- fit2$hypers$prior_mean[-l]
  fit2$hypers$prior_variance &lt;- fit2$hypers$prior_variance[-l]
  
  return(fit2)
}

#&#39; compute ElBO - ELBO_{-l}
#&#39; where ELBO_{-l} is the model with b_l=0
compute_component_lbfs &lt;- function(fit){
  lbfs &lt;- rep(0, fit$hypers$L)
  for(l in 1:fit$hypers$L){
    if(fit$hypers$prior_variance[l] &gt; 0.01){
      elbo_null &lt;- remove_effect(fit, l) %&gt;% fit.binsusie(fit_prior_variance = F) %&gt;% compute_elbo.binsusie()
      lbfs[l] &lt;- get_elbo(fit) - elbo_null
    }
  }
  return(lbfs)
}


tic()
fit1$lbf_component &lt;- cache_rds(compute_component_lbfs(fit1), file=&#39;fit1_lbf_component.rds&#39;)
fit3$lbf_component &lt;- cache_rds(compute_component_lbfs(fit3), file=&#39;fit3_lbf_component.rds&#39;)
fit5$lbf_component &lt;- cache_rds(compute_component_lbfs(fit5), file=&#39;fit5_lbf_component.rds&#39;)
fit10$lbf_component &lt;- cache_rds(compute_component_lbfs(fit10), file=&#39;fit10_lbf_component.rds&#39;)
fit20$lbf_component &lt;- cache_rds(compute_component_lbfs(fit20), file=&#39;fit20_lbf_component.rds&#39;)
fit50$lbf_component &lt;- cache_rds(compute_component_lbfs(fit50), file=&#39;fit50_lbf_component.rds&#39;)
toc()</code></pre>
<pre><code>0.017 sec elapsed</code></pre>
<pre class="r"><code>fit_summary_tbl &lt;- function(fit, name){
  fit %&gt;% cs_tbl %&gt;%
    ungroup() %&gt;%
    mutate(L=paste0(&#39;L&#39;, 1:fit$hypers$L), V=fit$V, lbf_component = fit$lbf_component, name=name, lbf_model=get_bf(fit)) %&gt;% 
    filter(V &gt; 0.05) %&gt;%
    select(-c(cs, prob))
}

fit_summary_tbl(fit1, &#39;top1&#39;) %&gt;% select(-c(size, requested_coverage)) %&gt;% select(c(name, everything())) %&gt;% kbl() %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
coverage
</th>
<th style="text-align:right;">
top_feaure
</th>
<th style="text-align:right;">
top_feature_alpha
</th>
<th style="text-align:left;">
L
</th>
<th style="text-align:right;">
V
</th>
<th style="text-align:right;">
lbf_component
</th>
<th style="text-align:right;">
lbf_model
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
top1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
L2
</td>
<td style="text-align:right;">
35.19241
</td>
<td style="text-align:right;">
1.734098
</td>
<td style="text-align:right;">
1.642393
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>fit_summary_tbl(fit3, &#39;top3&#39;) %&gt;% select(-c(size, requested_coverage)) %&gt;% select(c(name, everything())) %&gt;% kbl() %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
coverage
</th>
<th style="text-align:right;">
top_feaure
</th>
<th style="text-align:right;">
top_feature_alpha
</th>
<th style="text-align:left;">
L
</th>
<th style="text-align:right;">
V
</th>
<th style="text-align:right;">
lbf_component
</th>
<th style="text-align:right;">
lbf_model
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
top3
</td>
<td style="text-align:right;">
1.000
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
1.000
</td>
<td style="text-align:left;">
L2
</td>
<td style="text-align:right;">
22.069338
</td>
<td style="text-align:right;">
2.3756895
</td>
<td style="text-align:right;">
2.678083
</td>
</tr>
<tr>
<td style="text-align:left;">
top3
</td>
<td style="text-align:right;">
0.997
</td>
<td style="text-align:right;">
193
</td>
<td style="text-align:right;">
0.997
</td>
<td style="text-align:left;">
L3
</td>
<td style="text-align:right;">
3.056215
</td>
<td style="text-align:right;">
0.9506984
</td>
<td style="text-align:right;">
2.678083
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>fit_summary_tbl(fit5, &#39;top5&#39;) %&gt;% select(-c(size, requested_coverage)) %&gt;% select(c(name, everything())) %&gt;% kbl() %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
coverage
</th>
<th style="text-align:right;">
top_feaure
</th>
<th style="text-align:right;">
top_feature_alpha
</th>
<th style="text-align:left;">
L
</th>
<th style="text-align:right;">
V
</th>
<th style="text-align:right;">
lbf_component
</th>
<th style="text-align:right;">
lbf_model
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
top5
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L2
</td>
<td style="text-align:right;">
34.508153
</td>
<td style="text-align:right;">
2.9581629
</td>
<td style="text-align:right;">
3.896043
</td>
</tr>
<tr>
<td style="text-align:left;">
top5
</td>
<td style="text-align:right;">
0.9984901
</td>
<td style="text-align:right;">
193
</td>
<td style="text-align:right;">
0.9984901
</td>
<td style="text-align:left;">
L3
</td>
<td style="text-align:right;">
3.394975
</td>
<td style="text-align:right;">
2.1257680
</td>
<td style="text-align:right;">
3.896043
</td>
</tr>
<tr>
<td style="text-align:left;">
top5
</td>
<td style="text-align:right;">
0.9999799
</td>
<td style="text-align:right;">
479
</td>
<td style="text-align:right;">
0.9999799
</td>
<td style="text-align:left;">
L4
</td>
<td style="text-align:right;">
3.809129
</td>
<td style="text-align:right;">
0.8034604
</td>
<td style="text-align:right;">
3.896043
</td>
</tr>
<tr>
<td style="text-align:left;">
top5
</td>
<td style="text-align:right;">
0.9811354
</td>
<td style="text-align:right;">
773
</td>
<td style="text-align:right;">
0.9811354
</td>
<td style="text-align:left;">
L5
</td>
<td style="text-align:right;">
5.051019
</td>
<td style="text-align:right;">
0.7841456
</td>
<td style="text-align:right;">
3.896043
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>fit_summary_tbl(fit10, &#39;top10&#39;) %&gt;% select(-c(size, requested_coverage)) %&gt;% select(c(name, everything())) %&gt;% kbl() %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
coverage
</th>
<th style="text-align:right;">
top_feaure
</th>
<th style="text-align:right;">
top_feature_alpha
</th>
<th style="text-align:left;">
L
</th>
<th style="text-align:right;">
V
</th>
<th style="text-align:right;">
lbf_component
</th>
<th style="text-align:right;">
lbf_model
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
top10
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L2
</td>
<td style="text-align:right;">
34.433998
</td>
<td style="text-align:right;">
5.0669857
</td>
<td style="text-align:right;">
2.562625
</td>
</tr>
<tr>
<td style="text-align:left;">
top10
</td>
<td style="text-align:right;">
0.9999955
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
0.9999955
</td>
<td style="text-align:left;">
L3
</td>
<td style="text-align:right;">
1.705086
</td>
<td style="text-align:right;">
1.0136142
</td>
<td style="text-align:right;">
2.562625
</td>
</tr>
<tr>
<td style="text-align:left;">
top10
</td>
<td style="text-align:right;">
0.9804274
</td>
<td style="text-align:right;">
773
</td>
<td style="text-align:right;">
0.9804274
</td>
<td style="text-align:left;">
L4
</td>
<td style="text-align:right;">
5.104987
</td>
<td style="text-align:right;">
0.8057629
</td>
<td style="text-align:right;">
2.562625
</td>
</tr>
<tr>
<td style="text-align:left;">
top10
</td>
<td style="text-align:right;">
0.9999829
</td>
<td style="text-align:right;">
479
</td>
<td style="text-align:right;">
0.9999829
</td>
<td style="text-align:left;">
L5
</td>
<td style="text-align:right;">
3.920028
</td>
<td style="text-align:right;">
-1.1506547
</td>
<td style="text-align:right;">
2.562625
</td>
</tr>
<tr>
<td style="text-align:left;">
top10
</td>
<td style="text-align:right;">
0.9981110
</td>
<td style="text-align:right;">
193
</td>
<td style="text-align:right;">
0.9981110
</td>
<td style="text-align:left;">
L6
</td>
<td style="text-align:right;">
3.337498
</td>
<td style="text-align:right;">
-1.2020404
</td>
<td style="text-align:right;">
2.562625
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>fit_summary_tbl(fit20, &#39;top20&#39;) %&gt;% select(-c(size, requested_coverage)) %&gt;% select(c(name, everything())) %&gt;% kbl() %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
coverage
</th>
<th style="text-align:right;">
top_feaure
</th>
<th style="text-align:right;">
top_feature_alpha
</th>
<th style="text-align:left;">
L
</th>
<th style="text-align:right;">
V
</th>
<th style="text-align:right;">
lbf_component
</th>
<th style="text-align:right;">
lbf_model
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
top20
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L2
</td>
<td style="text-align:right;">
31.523943
</td>
<td style="text-align:right;">
-0.0978065
</td>
<td style="text-align:right;">
-4.983675
</td>
</tr>
<tr>
<td style="text-align:left;">
top20
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
860
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L3
</td>
<td style="text-align:right;">
20.816488
</td>
<td style="text-align:right;">
-0.1341506
</td>
<td style="text-align:right;">
-4.983675
</td>
</tr>
<tr>
<td style="text-align:left;">
top20
</td>
<td style="text-align:right;">
0.9999912
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
0.9999912
</td>
<td style="text-align:left;">
L4
</td>
<td style="text-align:right;">
1.659963
</td>
<td style="text-align:right;">
-1.5465872
</td>
<td style="text-align:right;">
-4.983675
</td>
</tr>
<tr>
<td style="text-align:left;">
top20
</td>
<td style="text-align:right;">
0.9999824
</td>
<td style="text-align:right;">
479
</td>
<td style="text-align:right;">
0.9999824
</td>
<td style="text-align:left;">
L5
</td>
<td style="text-align:right;">
3.904411
</td>
<td style="text-align:right;">
-2.1178359
</td>
<td style="text-align:right;">
-4.983675
</td>
</tr>
<tr>
<td style="text-align:left;">
top20
</td>
<td style="text-align:right;">
0.9802911
</td>
<td style="text-align:right;">
773
</td>
<td style="text-align:right;">
0.9802911
</td>
<td style="text-align:left;">
L6
</td>
<td style="text-align:right;">
5.088693
</td>
<td style="text-align:right;">
-1.0956006
</td>
<td style="text-align:right;">
-4.983675
</td>
</tr>
<tr>
<td style="text-align:left;">
top20
</td>
<td style="text-align:right;">
0.9980807
</td>
<td style="text-align:right;">
193
</td>
<td style="text-align:right;">
0.9980807
</td>
<td style="text-align:left;">
L7
</td>
<td style="text-align:right;">
3.326746
</td>
<td style="text-align:right;">
-1.3989800
</td>
<td style="text-align:right;">
-4.983675
</td>
</tr>
<tr>
<td style="text-align:left;">
top20
</td>
<td style="text-align:right;">
0.9958356
</td>
<td style="text-align:right;">
108
</td>
<td style="text-align:right;">
0.9958356
</td>
<td style="text-align:left;">
L8
</td>
<td style="text-align:right;">
4.188964
</td>
<td style="text-align:right;">
-2.4715687
</td>
<td style="text-align:right;">
-4.983675
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>fit_summary_tbl(fit50, &#39;top50&#39;) %&gt;% select(-c(size, requested_coverage)) %&gt;% select(c(name, everything())) %&gt;% kbl() %&gt;% kable_styling()</code></pre>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
coverage
</th>
<th style="text-align:right;">
top_feaure
</th>
<th style="text-align:right;">
top_feature_alpha
</th>
<th style="text-align:left;">
L
</th>
<th style="text-align:right;">
V
</th>
<th style="text-align:right;">
lbf_component
</th>
<th style="text-align:right;">
lbf_model
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
top50
</td>
<td style="text-align:right;">
0.9998640
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
0.9998640
</td>
<td style="text-align:left;">
L1
</td>
<td style="text-align:right;">
1.431768
</td>
<td style="text-align:right;">
1.6007490
</td>
<td style="text-align:right;">
-41.91326
</td>
</tr>
<tr>
<td style="text-align:left;">
top50
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L2
</td>
<td style="text-align:right;">
12.935933
</td>
<td style="text-align:right;">
-0.6957896
</td>
<td style="text-align:right;">
-41.91326
</td>
</tr>
<tr>
<td style="text-align:left;">
top50
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
860
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L3
</td>
<td style="text-align:right;">
21.288600
</td>
<td style="text-align:right;">
-7.4491317
</td>
<td style="text-align:right;">
-41.91326
</td>
</tr>
<tr>
<td style="text-align:left;">
top50
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
332
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L4
</td>
<td style="text-align:right;">
14.723669
</td>
<td style="text-align:right;">
-8.1012910
</td>
<td style="text-align:right;">
-41.91326
</td>
</tr>
<tr>
<td style="text-align:left;">
top50
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
582
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L5
</td>
<td style="text-align:right;">
13.016000
</td>
<td style="text-align:right;">
-8.4954238
</td>
<td style="text-align:right;">
-41.91326
</td>
</tr>
<tr>
<td style="text-align:left;">
top50
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
116
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L6
</td>
<td style="text-align:right;">
17.275133
</td>
<td style="text-align:right;">
-7.9244134
</td>
<td style="text-align:right;">
-41.91326
</td>
</tr>
<tr>
<td style="text-align:left;">
top50
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:right;">
779
</td>
<td style="text-align:right;">
1.0000000
</td>
<td style="text-align:left;">
L7
</td>
<td style="text-align:right;">
10.774081
</td>
<td style="text-align:right;">
-8.6786796
</td>
<td style="text-align:right;">
-41.91326
</td>
</tr>
<tr>
<td style="text-align:left;">
top50
</td>
<td style="text-align:right;">
0.9998337
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
0.9998337
</td>
<td style="text-align:left;">
L9
</td>
<td style="text-align:right;">
3.144541
</td>
<td style="text-align:right;">
-7.6073493
</td>
<td style="text-align:right;">
-41.91326
</td>
</tr>
<tr>
<td style="text-align:left;">
top50
</td>
<td style="text-align:right;">
0.9999724
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
0.9999724
</td>
<td style="text-align:left;">
L10
</td>
<td style="text-align:right;">
3.375233
</td>
<td style="text-align:right;">
-9.3502987
</td>
<td style="text-align:right;">
-41.91326
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>unlist(fit1$sets$cs)</code></pre>
<pre><code> L2 
197 </code></pre>
<pre class="r"><code>unlist(fit3$sets$cs)</code></pre>
<pre><code> L2  L3 
197 193 </code></pre>
<pre class="r"><code>unlist(fit5$sets$cs)</code></pre>
<pre><code> L2  L3  L4  L5 
197 193 479 773 </code></pre>
<pre class="r"><code>unlist(fit10$sets$cs)</code></pre>
<pre><code> L2  L3  L4  L5  L6 
197  16 773 479 193 </code></pre>
<pre class="r"><code>unlist(fit20$sets$cs)</code></pre>
<pre><code> L2  L3  L4  L5  L6  L7  L8 
197 860  16 479 773 193 108 </code></pre>
<pre class="r"><code>unlist(fit50$sets$cs)</code></pre>
<pre><code> L1  L2  L3  L4  L5  L6  L7  L9 L10 
 16 197 860 332 582 116 779  18  13 </code></pre>
<pre class="r"><code># rank of BFs
order(desc(uvb_ser$BF)) %&gt;% head(50)</code></pre>
<pre><code>integer(0)</code></pre>
<p>For a fixed <span class="math inline">\(\xi\)</span> and <span
class="math inline">\(\mathbb E x_i^Tb\)</span>, reducing the variance
of the linear predictor improves the likelihood bound. Of course, this
also increases <span class="math inline">\(D_{{KL}(q(b) ||
p(b))}\)</span>…</p>
<pre class="r"><code>Xb &lt;- compute_Xb.binsusie(fit)
kappa &lt;- compute_kappa(fit)
n &lt;- .get_N(fit)
Xb2 &lt;- drop(compute_Xb2.binsusie(fit))
Xi &lt;- fit$params$xi

jj_xi &lt;- function(xi, idx, xb2){
  omega &lt;- pg_mean(n[idx], xi)
  bound &lt;- n[idx] * log(sigmoid(xi)) + (kappa[idx] * Xb[idx]) - (0.5 * n[idx] * xi) + 0.5 * omega * (xi^2 - xb2)
  return(bound)
}

plot_jj_xi &lt;- function(idx){
  xb &lt;- Xb[idx]
  xb2 &lt;- Xb2[idx]
  xi &lt;- Xi[idx]
  xi_grid &lt;- seq(xi-1, xi+1, by=0.1)
  xb2_grid &lt;- c(seq(xb^2, xb2, by = 0.01), xb2)
  
  jj &lt;- crossing(xi=xi_grid, xb2=xb2_grid) %&gt;%
    rowwise() %&gt;%
    mutate(jj = jj_xi(xi, idx, xb2))
  jj %&gt;% filter(xi == Xi[idx]) %&gt;% pull(jj)
  
  plot(xi_grid, jj %&gt;% filter(xb2 == Xb2[idx]) %&gt;% pull(jj), ylim = range(jj$jj), type=&#39;l&#39;, ylab=&#39;jj_bound&#39;)
  lines(xi_grid, jj %&gt;% filter(xb2 == xb^2) %&gt;% pull(jj), ylim = range(jj$jj), type=&#39;l&#39;, col=&#39;blue&#39;)
  for(.xb2 in head(xb2_grid, -1)){
      lines(xi_grid, jj %&gt;% filter(xb2 == .xb2) %&gt;% pull(jj), ylim = range(jj$jj), lty=2)
  }
  abline(v=sqrt(xb2), col=&#39;red&#39;)
}

check_idx &lt;- which((Xb2 - Xb^2) &gt; 0.04)
par(mfrow=c(1,1))
plot_jj_xi(check_idx[1])</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/check_xi_modes-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-check_xi_modes-1">
Past versions of check_xi_modes-1.png
</button>
</p>
<div id="fig-check_xi_modes-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/check_xi_modes-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="some-heatmaps" class="section level4">
<h4>Some heatmaps</h4>
<p>All the fits are identifying a subset of the effects with positive
BFs. Here we plot the correlation of the selected variables with all
gene sets with positive marginal BF (ordered by marginal BF
largest-smallest left-right)</p>
<pre class="r"><code>n_pos &lt;- sum(uvb_ser$lbf &gt; 0)
top_bf &lt;- order(desc(uvb_ser$lbf)) %&gt;% head(n_pos)

heatmap(cor(
  as.matrix(bindata$X[, unlist(fit5$sets$cs)]),
  as.matrix(bindata$X[, top_bf])),
  scale = &#39;none&#39;, Colv = NA
)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-xi_glm_heatmaps-1">
Past versions of xi_glm_heatmaps-1.png
</button>
</p>
<div id="fig-xi_glm_heatmaps-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-1.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/b3f98c6debb36fc31f28d5cf2b0fcbb96748b830/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-1.png" target="_blank">b3f98c6</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/6728f824474066744b11556e451965d441e3a977/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-1.png" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>heatmap(cor(
  as.matrix(bindata$X[, unlist(fit10$sets$cs)]),
  as.matrix(bindata$X[, top_bf])),
  scale = &#39;none&#39;, Colv = NA
)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-xi_glm_heatmaps-2">
Past versions of xi_glm_heatmaps-2.png
</button>
</p>
<div id="fig-xi_glm_heatmaps-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-2.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/b3f98c6debb36fc31f28d5cf2b0fcbb96748b830/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-2.png" target="_blank">b3f98c6</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/6728f824474066744b11556e451965d441e3a977/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-2.png" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>heatmap(cor(
  as.matrix(bindata$X[, unlist(fit20$sets$cs)]),
  as.matrix(bindata$X[, top_bf])),
  scale = &#39;none&#39;, Colv = NA
)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-3.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-xi_glm_heatmaps-3">
Past versions of xi_glm_heatmaps-3.png
</button>
</p>
<div id="fig-xi_glm_heatmaps-3" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-3.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/b3f98c6debb36fc31f28d5cf2b0fcbb96748b830/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-3.png" target="_blank">b3f98c6</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/6728f824474066744b11556e451965d441e3a977/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-3.png" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>heatmap(cor(
  as.matrix(bindata$X[, unlist(fit50$sets$cs)]),
  as.matrix(bindata$X[, top_bf])),
  scale = &#39;none&#39;, Colv = NA
)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-4.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-xi_glm_heatmaps-4">
Past versions of xi_glm_heatmaps-4.png
</button>
</p>
<div id="fig-xi_glm_heatmaps-4" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/f908a0deb1e19a57a072b4dc6193f922e90fdab6/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-4.png" target="_blank">f908a0d</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-08
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/b3f98c6debb36fc31f28d5cf2b0fcbb96748b830/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-4.png" target="_blank">b3f98c6</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/6728f824474066744b11556e451965d441e3a977/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps-4.png" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Again, with hierarchical clustering applied to marginally enriched
gene sets</p>
<pre class="r"><code>n_pos &lt;- sum(uvb_ser$lbf &gt; 1)
top_bf &lt;- order(desc(uvb_ser$lbf)) %&gt;% head(n_pos)

heatmap(cor(
  as.matrix(bindata$X[, unlist(fit5$sets$cs)]),
  as.matrix(bindata$X[, top_bf])),
  scale = &#39;none&#39;
)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-xi_glm_heatmaps2-1">
Past versions of xi_glm_heatmaps2-1.png
</button>
</p>
<div id="fig-xi_glm_heatmaps2-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/b3f98c6debb36fc31f28d5cf2b0fcbb96748b830/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-1.png" target="_blank">b3f98c6</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/6728f824474066744b11556e451965d441e3a977/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-1.png" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>heatmap(cor(
  as.matrix(bindata$X[, unlist(fit10$sets$cs)]),
  as.matrix(bindata$X[, top_bf])),
  scale = &#39;none&#39;
)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-xi_glm_heatmaps2-2">
Past versions of xi_glm_heatmaps2-2.png
</button>
</p>
<div id="fig-xi_glm_heatmaps2-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/b3f98c6debb36fc31f28d5cf2b0fcbb96748b830/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-2.png" target="_blank">b3f98c6</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/6728f824474066744b11556e451965d441e3a977/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-2.png" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>heatmap(cor(
  as.matrix(bindata$X[, unlist(fit20$sets$cs)]),
  as.matrix(bindata$X[, top_bf])),
  scale = &#39;none&#39;
)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-3.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-xi_glm_heatmaps2-3">
Past versions of xi_glm_heatmaps2-3.png
</button>
</p>
<div id="fig-xi_glm_heatmaps2-3" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/b3f98c6debb36fc31f28d5cf2b0fcbb96748b830/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-3.png" target="_blank">b3f98c6</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/6728f824474066744b11556e451965d441e3a977/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-3.png" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>heatmap(cor(
  as.matrix(bindata$X[, unlist(fit50$sets$cs)]),
  as.matrix(bindata$X[, top_bf])),
  scale = &#39;none&#39;
)</code></pre>
<p><img src="figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-4.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-xi_glm_heatmaps2-4">
Past versions of xi_glm_heatmaps2-4.png
</button>
</p>
<div id="fig-xi_glm_heatmaps2-4" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/b3f98c6debb36fc31f28d5cf2b0fcbb96748b830/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-4.png" target="_blank">b3f98c6</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/karltayeb/logistic-susie-gsea/blob/6728f824474066744b11556e451965d441e3a977/docs/figure/logistic_susie_initialization.Rmd/xi_glm_heatmaps2-4.png" target="_blank">6728f82</a>
</td>
<td>
Karl Tayeb
</td>
<td>
2022-11-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>order(desc(uvb_ser$BF)) %&gt;% head(20)</code></pre>
<pre><code>integer(0)</code></pre>
<pre class="r"><code>knitr::knit_exit()</code></pre>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
https://docs.mathjax.org/en/latest/web/configuration.html. This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>




</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
