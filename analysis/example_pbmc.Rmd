---
title: "Logistic SuSiE Report Template"
author: "karltayeb"
date: "2022-04-11"
output:
  workflowr::wflow_html:
    code_folding: hide
editor_options:
  chunk_output_type: console
params:
  cache_dir: 'cache/example_pbmc/'
  genesets: c('gobp')
  thresh: 1e-4
  rerun: FALSE  # set to true to ignore cache
---

## Introduction


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = '#>',
  message=FALSE, warning=FALSE
)
```

```{r load.results}
library(gseasusie)
library(ggplot2)
library(tidyverse)
library(targets)

tar_load(sc_pbmc_deseq_enrichment_summary)
results <- sc_pbmc_deseq_enrichment_summary
```

```{r plot.function, hide=TRUE}
color_sign <- gseasusie:::color_sign

interactive_table2 = function(res){
  dt <- res %>% 
    dplyr::filter(overlap > 0) %>%
    dplyr::mutate(
      logOddsRatio = log(oddsRatio),
      nlog10pFishersExact = -log10(pFishersExact)
    ) %>%
    dplyr::arrange(dplyr::desc(nlog10pFishersExact)) %>%
    dplyr::mutate(
      fisherRank = dplyr::row_number(),
      in_active_cs = dplyr::if_else(is.na(in_cs), FALSE, in_cs & active_cs)) %>%
    dplyr::select(geneSet, description, in_active_cs, beta, pip, overlap, geneSetSize, logOddsRatio, nlog10pFishersExact, component, fisherRank) %>%
    dplyr::mutate(dplyr::across(!where(is.numeric), as.factor))

  dt %>%
    reactable::reactable(
      filterable=TRUE,
      minRows=20,
      columns = list(
        pip = reactable::colDef(format = reactable::colFormat(digits = 3)),
        logOddsRatio = reactable::colDef(style= function(value){color_sign(value)},
                                         format = reactable::colFormat(digits = 3)),
        beta = reactable::colDef(style= function(value){color_sign(value)},
                                 format = reactable::colFormat(digits = 3)),
        nlog10pFishersExact = reactable::colDef(format = reactable::colFormat(digits = 3))
      ),
      rowStyle = function(index){
        if(dt$in_active_cs[index] == TRUE){
          list(background = "#e5f5e0")
        }
      },
      defaultSorted = list(nlog10pFishersExact='desc')
    )
}

#' @export
residual_enrichment_histogram2 = function(res){
  res %>%
    dplyr::select(geneSet, pval_marginal, pval_residual) %>%
    tidyr::pivot_longer(dplyr::starts_with('pval'), values_to = 'pval') %>%
    ggplot2::ggplot(aes(x=pval)) +
      ggplot2::geom_histogram() + ggplot2::facet_wrap(vars(name))
}
```


## Enrichment results

```{r experiment.level.results, results='asis'}
results <- results %>% arrange(experiment, ptop, db)
N <- dim(results)[1]
for (i in 1:N){
  this_experiment <- results$experiment[[i]]
  this_db <- results$db[[i]]
  this_ptop <- results$ptop[[i]]
  res <- results$enrichment_summary[[i]]

  cat("\n") 
  cat("###", this_experiment, ' ', this_ptop, ' ', this_db, "\n") # Create second level headings with the names.

  volcano <- res %>% gseasusie::enrichment_volcano2()
  hist <- res %>% filter(overlap > 0) %>% residual_enrichment_histogram2() 
  print(volcano)
  print(hist)

  cat("\n\n") 
  print(shiny::tagList(interactive_table2(res)))
}
```

### Glossary

* `alpha` is the posterior probability of SuSiE including this gene set **in this component** which is different from PIP (probability of SuSiE including this gene set in ANY component)
* `beta` posterior mean/standard error of posterior mean for effect size. Standard errors are likely too small. 
* `oddsRatio, pHypergeometric, pFishersExact` construct a contingency table (gene list membersip) x (gene set membership), estimate the `oddsRatio` gives the odds of being in the gene list conditional on being in the gene set / odds of being in the gene list conditional on NOT being in the gene set. `pHypergeometric` and `pFishersExact` are pvalues from 1 and 2 sided test respectively. 


```{r}
#' @param tbl output of \alias{get_credible_set_summary} to be formatted
#' @param target_coverage the coverage of the credible sets to be reported
#' @param max_coverage report SNPs that are not in the target_coverage c.s. up this value
#' @param max_sets maximum number of gene sets to report for a single credible set
#'    this is useful for large credible sets
#' @return A styled kable table suitable for rendering in an HTML document
#' @export
report_susie_credible_sets = function(tbl,
                                      target_coverage=0.95,
                                      max_coverage=0.99,
                                      max_sets=10){
  require(kableExtra)
  tbl_filtered <-
    tbl %>%
    group_by(component) %>%
    arrange(component, desc(alpha)) %>%
    dplyr::filter(cumalpha <= max_coverage, alpha_rank <= max_sets) %>%
    dplyr::mutate(in_cs = cumalpha <= target_coverage) %>% 
    dplyr::ungroup() %>%
    dplyr::mutate(logOddsRatio = log10(oddsRatio))

  tbl_filtered %>%
    dplyr::select(component, geneSet, description, geneSetSize, overlap, logOddsRatio, beta, beta.se, alpha, pFishersExact) %>%
    dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>%
    pack_group %>%
    column_spec(c(5, 6), color=ifelse(tbl_filtered$beta > 0, 'green', 'red')) %>%
    kableExtra::kable_styling()
}
```
